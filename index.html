<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Nursing Calendar Scheduler — Enhanced UI</title>
  <!-- Admin Authentication Modal -->
  <div id="adminAuthModal" class="modal">
    <div class="modal-content" style="max-width: 400px;">
      <div class="modal-header">
        <h3 class="modal-title">Admin Authentication</h3>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label for="adminPassword">Enter Admin Password</label>
          <input type="password" id="adminPassword" class="form-control" placeholder="Enter password">
          <div class="hint" style="margin-top: 8px; color: var(--text-muted);">Contact administrator for access</div>
        </div>
        <div class="btn-group" style="justify-content: flex-end; margin-top: 1rem;">
          <button id="adminLoginBtn" class="btn btn-primary">Login</button>
          <button onclick="closeAdminAuth()" class="btn btn-secondary">Cancel</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Admin Toolbar -->
  <div id="adminToolbar" class="admin-toolbar admin-only" style="display: none;">
    <button id="exportValidationReportBtn" class="btn btn-admin">Validation Report</button>
    <button id="exportIssuesCsvBtn" class="btn btn-admin">Export Issues CSV</button>
    <button id="backupRestoreBtn" class="btn btn-admin">Backup/Restore</button>
    <button id="exportNormalizedCsvBtn" class="btn btn-admin">Export Normalized CSV</button>
    <button id="dataAnalyticsBtn" class="btn btn-admin">Data Analytics</button>
    <button id="adminLogoutBtn" class="btn btn-danger">Logout Admin</button>
  </div>

  <!-- Backup/Restore Modal -->
  <div id="backupRestoreModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">Backup & Restore</h3>
        <button onclick="closeBackupRestore()" class="btn btn-secondary">&times;</button>
      </div>
      <div class="modal-body">
        <div class="backup-section">
          <h4>Current Backups</h4>
          <div id="backupsList" class="backup-list"></div>
        </div>
        <div class="form-group" style="margin-top: 1rem;">
          <button id="createBackupBtn" class="btn btn-primary">Create New Backup</button>
        </div>
        <hr style="margin: 1rem 0;">
        <div class="restore-section">
          <h4>Restore Options</h4>
          <div class="form-group">
            <label for="restoreFile">Upload Backup File</label>
            <input type="file" id="restoreFile" class="form-control" accept=".json">
          </div>
          <div class="btn-group" style="margin-top: 1rem;">
            <button id="restoreFromFileBtn" class="btn btn-primary">Restore from File</button>
            <button onclick="closeBackupRestore()" class="btn btn-secondary">Cancel</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <style>
    /* Admin Styles */
    .admin-toolbar {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: var(--primary);
      padding: 0.5rem 1rem;
      display: flex;
      gap: 0.5rem;
      align-items: center;
      z-index: 1000;
      box-shadow: var(--shadow-md);
    }

    .admin-toolbar .btn {
      font-size: 0.813rem;
      padding: 0.375rem 0.75rem;
    }

    body.admin-mode {
      padding-top: 3.5rem;
    }

    .backup-list {
      max-height: 200px;
      overflow-y: auto;
      border: 1px solid var(--border);
      border-radius: 0.5rem;
      padding: 0.5rem;
      margin-top: 0.5rem;
    }

    .backup-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.5rem;
      border-bottom: 1px solid var(--border);
    }

    .backup-item:last-child {
      border-bottom: none;
    }

    /* Modern UI Variables */
    :root {
      --primary: #3b82f6;
      --primary-hover: #2563eb;
      --secondary: #eff6ff;
      --success: #059669;
      --danger: #dc2626;
      --warning: #d97706;
      --info: #3b82f6;
      --bg: #eff6ff;
      --card: #ffffff;
      --text: #0f172a;
      --text-muted: #64748b;
      --border: #93c5fd;
      --sep-blue: #dbeafe;
      --sep-blue-border: #93c5fd;
      
      /* Spacing */
      --spacing-xs: 0.25rem;
      --spacing-sm: 0.5rem;
      --spacing-md: 1rem;
      --spacing-lg: 1.5rem;
      --spacing-xl: 2rem;
      
      /* Shadows */
      --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
    }

    /* Reset & Base Styles */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: system-ui, -apple-system, 'Segoe UI', Roboto, Ubuntu, 'Helvetica Neue', Arial, sans-serif;
      line-height: 1.5;
      font-size: 14px;
    }

    /* Layout */
    .container {
      max-width: 1400px;
      margin: 2rem auto;
      padding: 0 var(--spacing-md);
    }

    /* Header Styles */
    .header {
      margin-bottom: var(--spacing-xl);
    }

    .header h1 {
      font-size: 1.875rem;
      font-weight: 800;
      color: var(--primary);
      margin-bottom: var(--spacing-xs);
    }

    .header .subtitle {
      color: var(--text-muted);
      font-size: 0.938rem;
    }

    /* Controls Section */
    .controls-section {
      background: var(--card);
      border-radius: 12px;
      padding: var(--spacing-lg);
      box-shadow: var(--shadow-md);
      margin-bottom: var(--spacing-lg);
    }

    .controls-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: var(--spacing-md);
      margin-bottom: var(--spacing-md);
    }

    /* Form Controls */
    .form-group {
      margin-bottom: var(--spacing-sm);
    }

    .form-group label {
      display: block;
      margin-bottom: var(--spacing-xs);
      font-weight: 500;
      color: var(--text);
    }

    .form-control {
      width: 100%;
      padding: 0.5rem 0.75rem;
      border: 1px solid var(--border);
      border-radius: 0.5rem;
      font-size: 0.875rem;
      transition: border-color 0.15s ease;
    }

    .form-control:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
    }

    /* Specific styling for month and year controls */
    #monthSelect {
      max-width: 180px;
      width: 180px;
    }
    
    #yearInput {
      max-width: 100px;
      width: 100px;
    }

    /* Adjust controls grid for better alignment */
    .controls-grid {
      display: grid;
      grid-template-columns: 180px 100px 200px auto;
      gap: var(--spacing-sm);
      margin-bottom: var(--spacing-md);
      align-items: end;
    }

    /* Reduce gap specifically between year and apply button to match button spacing */
    .controls-grid .form-group:nth-child(2) {
      margin-right: -4rem;
    }
    
    .controls-grid .form-group:nth-child(3) {
      margin-left: -4rem;
    }

    /* Ensure Apply Calendar button aligns properly */
    .controls-grid .form-group {
      display: flex;
      flex-direction: column;
    }

    .controls-grid .form-group button {
      margin-top: auto;
    }

    /* Buttons */
    .btn-group {
      display: flex;
      gap: var(--spacing-sm);
      flex-wrap: wrap;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0.5rem 1rem;
      border-radius: 0.5rem;
      font-weight: 500;
      font-size: 0.875rem;
      cursor: pointer;
      transition: all 0.15s ease;
      border: 1px solid transparent;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
    }

    .btn-primary:hover {
      background: var(--primary-hover);
    }

    .btn-secondary {
      background: var(--secondary);
      color: var(--text);
      border-color: var(--border);
    }

    .btn-secondary:hover {
      background: #e2e8f0;
    }

    .btn-admin {
      background: var(--info);
      color: white;
    }

    .btn-admin:hover {
      background: #2563eb;
    }

    .btn-warning {
      background: var(--warning);
      color: white;
    }

    .btn-warning:hover {
      background: #b45309;
    }

    .btn-danger {
      background: var(--danger);
      color: white;
    }

    .btn-danger:hover {
      background: #b91c1c;
    }

    /* Search Bar */
    .search-container {
      margin-bottom: var(--spacing-lg);
      position: relative;
    }

    .search-wrapper {
      position: relative;
      display: flex;
      align-items: center;
      max-width: 600px;
      margin: 0 auto;
    }

    .search-input {
      width: 100%;
      padding: 0.75rem 3rem 0.75rem 2.5rem;
      border: 2px solid var(--border);
      border-radius: 2rem;
      font-size: 0.875rem;
      background: white;
      box-shadow: var(--shadow-sm);
      transition: all 0.2s ease;
    }

    .search-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1), var(--shadow-md);
      transform: translateY(-1px);
    }

    .search-input:not(:placeholder-shown) {
      border-color: var(--primary);
      background: var(--bg);
    }

    .search-icon {
      position: absolute;
      left: 0.75rem;
      top: 50%;
      transform: translateY(-50%);
      color: #6b7280;
      font-size: 1rem;
      pointer-events: none;
    }

    .search-clear {
      position: absolute;
      right: 0.75rem;
      top: 50%;
      transform: translateY(-50%);
      background: #ef4444;
      color: white;
      border: none;
      border-radius: 50%;
      width: 1.5rem;
      height: 1.5rem;
      cursor: pointer;
      font-size: 0.75rem;
      display: none;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }

    .search-clear:hover {
      background: #dc2626;
      transform: translateY(-50%) scale(1.1);
    }

    .search-clear.show {
      display: flex;
    }

    .search-results-info {
      text-align: center;
      margin-top: 0.5rem;
      font-size: 0.813rem;
      color: #6b7280;
      min-height: 1.2rem;
    }

    .search-results-info.active {
      color: var(--primary);
      font-weight: 500;
    }

    /* Table Styles */
    .table-container {
      background: var(--card);
      border-radius: 12px;
      box-shadow: var(--shadow-lg);
      overflow: hidden;
    }

    .table-info-panel {
      background: var(--secondary);
      border-bottom: 1px solid var(--border);
      padding: 0.75rem 1rem;
    }

    .info-stats {
      display: flex;
      gap: 1.5rem;
      flex-wrap: wrap;
      align-items: center;
    }

    .info-stat {
      font-size: 0.875rem;
      color: var(--text);
    }

    .info-stat strong {
      color: var(--primary);
      font-weight: 600;
    }

    .table-scroll {
      overflow-x: auto;
      max-height: 70vh;
    }

    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      table-layout: fixed;
    }

    th, td {
      padding: 0.75rem;
      border: 1px solid var(--border);
      background: white;
    }

    th {
      background: var(--primary);
      color: white;
      font-weight: 600;
      text-align: left;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    /* Sticky columns */
    .col-item { width: 80px; }
    .col-month { width: 140px; }
    .col-cohort { width: 190px; }

    .sticky-col {
      position: sticky;
      background: white;
      z-index: 25;
    }

    /* Sticky header columns should maintain turquoise background and stay fixed */
    th.sticky-col {
      background: var(--primary);
      color: white;
      position: sticky;
      top: 0;
      z-index: 30;
    }

    .sticky-col-1 { left: 0; }
    .sticky-col-2 { left: 80px; }

    /* Group separator */
    tr.group-sep td {
      background: var(--sep-blue) !important;
      border-top: 2px solid var(--sep-blue-border);
      border-bottom: 2px solid var(--sep-blue-border);
    }

    /* Dropdowns in table */
    .table-select {
      width: 100%;
      padding: 0.375rem 0.5rem;
      border: 1px solid var(--border);
      border-radius: 0.375rem;
      font-size: 0.875rem;
      background: white;
    }

    /* Fullscreen adjustments */
    body.fullscreen .table-scroll {
      max-height: calc(100vh - 180px);
    }

    body.fullscreen .container {
      max-width: none;
    }

    body.fullscreen .table-container {
      border-radius: 0;
    }

    /* Modern Modal Styles */
    .modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 100;
      backdrop-filter: blur(4px);
    }

    .modal-content {
      background: white;
      border-radius: 12px;
      box-shadow: var(--shadow-lg);
      max-width: 600px;
      width: 90%;
      margin: 4vh auto;
      padding: var(--spacing-lg);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--spacing-md);
    }

    .modal-title {
      font-size: 1.25rem;
      font-weight: 600;
    }

    /* Toast Notifications */
    .toast-container {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 1000;
    }

    .toast {
      padding: 1rem;
      border-radius: 8px;
      background: white;
      box-shadow: var(--shadow-lg);
      margin-top: 0.5rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    /* Admin Features */
    .admin-only {
      display: none;
    }

    body.admin-mode .admin-only {
      display: flex;
    }

    /* Analytics Modal Styles */
    .analytics-modal-content {
      max-width: 95%;
      width: 1400px;
      height: 90vh;
      margin: 2vh auto;
    }

    .analytics-controls {
      background: var(--secondary);
      padding: var(--spacing-md);
      border-radius: 8px;
      margin-bottom: var(--spacing-md);
    }

    .analytics-row {
      display: flex;
      gap: var(--spacing-md);
      margin-bottom: var(--spacing-sm);
      align-items: end;
    }

    .analytics-row .form-group {
      flex: 1;
      min-width: 200px;
    }

    .checkbox-group {
      display: flex;
      align-items: center;
      margin-top: 1.5rem;
    }

    .checkbox-label {
      display: flex;
      align-items: center;
      cursor: pointer;
      font-weight: 500;
    }

    .checkbox-label input[type="checkbox"] {
      margin-right: 8px;
      transform: scale(1.2);
    }

    .analytics-actions {
      display: flex;
      gap: var(--spacing-sm);
      justify-content: center;
      margin-top: var(--spacing-md);
    }

    .analytics-results {
      display: flex;
      gap: var(--spacing-md);
      height: calc(90vh - 250px);
    }

    .chart-container {
      flex: 2;
      background: white;
      border-radius: 8px;
      padding: var(--spacing-md);
      border: 1px solid var(--border);
    }

    .analytics-table-container {
      flex: 1;
      background: white;
      border-radius: 8px;
      padding: var(--spacing-md);
      border: 1px solid var(--border);
      overflow-y: auto;
      color: #000000;
    }

    .analytics-table-container h4 {
      color: #000000;
      font-weight: 600;
      margin-bottom: var(--spacing-sm);
    }

    .summary-stats {
      background: var(--secondary);
      padding: var(--spacing-sm);
      border-radius: 6px;
      margin-bottom: var(--spacing-md);
    }

    .summary-stats .stat-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 4px;
      font-size: 0.9rem;
      color: #000000;
    }

    .analytics-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
      color: #000000;
    }

    .analytics-table th,
    .analytics-table td {
      padding: 8px 4px;
      text-align: left;
      border-bottom: 1px solid var(--border);
      color: #000000;
    }

    .analytics-table th {
      background: var(--secondary);
      font-weight: 600;
      position: sticky;
      top: 0;
      color: #000000;
    }

    .analytics-table td {
      font-family: 'Courier New', monospace;
      color: #000000;
    }

    #dataChart {
      max-height: 400px;
    }
  </style>
</head>
<body>
  <!-- Toast Container -->
  <div class="toast-container"></div>

  <div class="container">
    <header class="header">
      <h1>Nursing Calendar Scheduler</h1>
      <p class="subtitle">Enhanced UI with improved navigation and responsive design</p>
    </header>

    <section class="controls-section">
      <div class="controls-grid">
        <div class="form-group">
          <label for="monthSelect">Month</label>
          <select id="monthSelect" class="form-control" onchange="document.getElementById('monthAbbrev').value = this.value">
            <option value="">Select Month</option>
            <option value="JAN">January</option>
            <option value="FEB">February</option>
            <option value="MAR">March</option>
            <option value="APR">April</option>
            <option value="MAY">May</option>
            <option value="JUN">June</option>
            <option value="JUL">July</option>
            <option value="AUG">August</option>
            <option value="SEP">September</option>
            <option value="OCT">October</option>
            <option value="NOV">November</option>
            <option value="DEC">December</option>
          </select>
          <input type="hidden" id="monthAbbrev" class="form-control" placeholder="e.g., NOV">
        </div>
        <div class="form-group">
          <label for="yearInput">Year</label>
          <input type="number" id="yearInput" class="form-control" value="2025" min="2000" max="2100">
        </div>
        <div class="form-group" style="display: flex; align-items: flex-end;">
          <button id="applyCal" class="btn btn-primary">Apply Calendar</button>
        </div>
        <div class="form-group" style="display: flex; align-items: flex-end;">
          <button id="toggleFullBtn" class="btn btn-primary">Enter Full Screen</button>
        </div>
      </div>

      <div class="btn-group">
        <!-- Regular Buttons -->
        <input type="file" id="fileInput" accept=".xlsx,.xls,.csv" style="display: none;">
        <input type="file" id="csvFileInput" accept=".csv" style="display: none;">
        <button id="importXlsxBtn" class="btn btn-primary">Import XLSX</button>
        <button id="importCsvBtn" class="btn btn-admin admin-only">Import CSV</button>
        <button id="exportXlsxBtn" class="btn btn-primary">Export XLSX</button>
        <button id="exportCsvBtn" class="btn btn-primary">Export CSV</button>
        <button id="manageDropdowns" class="btn btn-primary">Manage Lists</button>
        <button id="manageColumns" class="btn btn-primary">Manage Columns</button>
        <button id="clearAllDataBtnMain" class="btn btn-warning">Clear All Data</button>
        <button id="saveBtn" class="btn btn-admin admin-only">Save</button>
        <button id="restoreBtn" class="btn btn-admin admin-only">Restore</button>
      </div>
    </section>

    <div class="search-container">
      <div class="search-wrapper">
        <span class="search-icon">🔍</span>
        <input type="text" id="search" class="search-input" placeholder="Search by day, cohort, instructor, or site...">
        <button id="searchClear" class="search-clear" title="Clear search">×</button>
      </div>
      <div id="searchResults" class="search-results-info"></div>
    </div>

    <div class="table-container">
      <div class="table-info-panel">
        <div class="info-stats">
          <span class="info-stat">
            <strong>Total Rows:</strong> <span id="totalRows">0</span>
          </span>
          <span class="info-stat">
            <strong>Data Entries:</strong> <span id="dataEntries">0</span>
          </span>
          <span class="info-stat">
            <strong>Days:</strong> <span id="totalDays">0</span>
          </span>
          <span class="info-stat">
            <strong>Cohorts:</strong> <span id="totalCohorts">0</span>
          </span>
        </div>
      </div>
      <div id="tableWrap" class="table-scroll"></div>
    </div>
  </div>

  <!-- Manage Lists Modal -->
  <div id="listsModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">Manage Lists</h3>
        <button id="closeLists" class="btn btn-secondary">&times;</button>
      </div>
      <div class="modal-body">
        <div style="background: #dbeafe; border: 1px solid #93c5fd; border-radius: 0.5rem; padding: 0.75rem; margin-bottom: 1rem;">
          <strong>Note:</strong> The following options are automatically included and protected:
          <ul style="margin: 0.5rem 0 0 1rem; font-size: 0.875rem;">
            <li><strong>Empty option</strong> (first in list) - for blank selections</li>
            <li><strong>"Custom"</strong> - allows users to enter custom values</li>
            <li><strong>"Clear"</strong> - clears the selected field</li>
          </ul>
          <em style="font-size: 0.813rem;">These options cannot be removed and will be added automatically.</em>
        </div>
        <div class="form-group">
          <label for="sitesInput">Sites (one per line)</label>
          <textarea id="sitesInput" class="form-control" rows="6"></textarea>
        </div>
        <div class="form-group">
          <label for="instInput">Instructors (one per line)</label>
          <textarea id="instInput" class="form-control" rows="6"></textarea>
        </div>
        <div class="form-group">
          <label for="timesInput">Schedule Templates (one per line)</label>
          <textarea id="timesInput" class="form-control" rows="6"></textarea>
        </div>
        <div class="btn-group" style="justify-content: flex-end; margin-top: 1rem;">
          <button id="saveLists" class="btn btn-primary">Save Changes</button>
          <button class="btn btn-secondary" onclick="closeLists()">Cancel</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Manage Columns Modal -->
  <div id="columnsModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">Manage Columns (Cohorts)</h3>
        <button id="closeColumns" class="btn btn-secondary">&times;</button>
      </div>
      <div class="modal-body">
        <div style="background: #dbeafe; border: 1px solid #93c5fd; border-radius: 0.5rem; padding: 0.75rem; margin-bottom: 1rem;">
          <strong>Note:</strong> Each cohort becomes a column in the calendar grid. You can add, remove, or reorder cohorts here.
          <br><em style="font-size: 0.813rem;">Changes will be applied immediately to the calendar.</em>
        </div>
        <div class="form-group">
          <label for="columnsInput">Cohorts/Columns (one per line)</label>
          <textarea id="columnsInput" class="form-control" rows="8" placeholder="Enter cohort names, one per line..."></textarea>
        </div>
        <div class="btn-group" style="justify-content: space-between; margin-top: 1rem;">
          <button id="resetColumns" class="btn btn-warning">Reset to Default</button>
          <div class="btn-group">
            <button id="saveColumns" class="btn btn-primary">Save Changes</button>
            <button class="btn btn-secondary" onclick="closeColumns()">Cancel</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Data Analytics Modal -->
  <div id="analyticsModal" class="modal">
    <div class="modal-content analytics-modal-content">
      <div class="modal-header">
        <h3 class="modal-title">Data Analytics</h3>
        <button id="closeAnalytics" class="btn btn-secondary">&times;</button>
      </div>
      <div class="modal-body">
        <div class="analytics-controls">
          <div class="analytics-row">
            <div class="form-group">
              <label for="timePeriod">Time Period</label>
              <select id="timePeriod" class="form-control">
                <option value="week">1 Week</option>
                <option value="2weeks">2 Weeks</option>
                <option value="month">1 Month</option>
              </select>
            </div>
            <div class="form-group">
              <label for="facultySelect">Faculty Selection</label>
              <select id="facultySelect" class="form-control">
                <option value="all">All Faculty Members</option>
                <option value="individual">Individual Analysis</option>
              </select>
            </div>
            <div class="form-group">
              <label for="specificFaculty">Specific Faculty (if Individual)</label>
              <select id="specificFaculty" class="form-control" disabled>
                <option value="">Select Faculty Member</option>
              </select>
            </div>
          </div>
          
          <div class="analytics-row">
            <div class="form-group">
              <label for="chartType">Chart Type</label>
              <select id="chartType" class="form-control">
                <option value="bar">Bar Graph</option>
                <option value="line">Line Chart</option>
                <option value="pie">Pie Chart</option>
                <option value="histogram">Histogram</option>
              </select>
            </div>
            <div class="form-group">
              <label for="analysisType">Analysis Type</label>
              <select id="analysisType" class="form-control">
                <option value="hours">Total Hours</option>
                <option value="comparative">Comparative Analysis</option>
                <option value="trends">Time Trends</option>
              </select>
            </div>
            <div class="form-group checkbox-group">
              <label class="checkbox-label">
                <input type="checkbox" id="deductLunch">
                <span class="checkmark"></span>
                Deduct 0.5h lunch break per day
              </label>
            </div>
          </div>
          
          <div class="analytics-actions">
            <button id="generateAnalytics" class="btn btn-primary">Generate Analytics</button>
            <button id="exportAnalytics" class="btn btn-secondary">Export Chart</button>
            <button id="clearAnalytics" class="btn btn-warning">Clear</button>
          </div>
        </div>
        
        <div id="analyticsResults" class="analytics-results">
          <div id="analyticsChart" class="chart-container">
            <canvas id="dataChart"></canvas>
          </div>
          <div id="analyticsTable" class="analytics-table-container">
            <h4>Data Summary</h4>
            <div id="summaryStats" class="summary-stats"></div>
            <table id="detailsTable" class="analytics-table">
              <thead></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Chart.js Library -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- XLSX Library -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <!-- ExcelJS Library for Professional Styling -->
  <script src="https://cdn.jsdelivr.net/npm/exceljs@4.3.0/dist/exceljs.min.js"></script>

  <script>
    // State Management
    let state = {
      monthAbbrev: "",
      year: 2025,
      daysInMonth: 30,
      cohorts: ["VN B111 (D)","VN B113 (D)","VN B108 (D)","VN B112 (E)","VN B107 (E)","VN B109 (E)","VN B103","VN B110 (10)","NATP/HHA","RN-BSN","Make Up","Admin"],
      groupsPerDay: 4,
      data: {}
    };

    // DROPDOWN LISTS WITH SITE NAMES, INSTRUCTORS, AND SCHEDULE TEMPLATES
    const ORIGINAL_LISTS = {
      sites: [
        "",
        "Rosecrans A",
        "Kei Ai A", 
        "Pacific Palms A",
        "Gerontology",
        "Harbor B",
        "Beachside B",
        "TCCW B",
        "Maternity",
        "Endocrine",
        "den",
        "jen",
        "test",
        "Daniel",
        "Custom",
        "Clear"
      ],
      instructors: [
        "",
        "Lipkins",
        "Samad",
        "Garvida",
        "Espejo",
        "Assayag",
        "Sortigosa",
        "Tacandong",
        "Harmon",
        "Mendiola",
        "Thomas",
        "Dr. Valer",
        "Manansa",
        "den",
        "jen",
        "test",
        "Daniel",
        "Custom",
        "Clear"
      ],
      schedule: [
        "",
        "0700-1530",
        "0800-1600",
        "0900-1500",
        "1500-2330",
        "1600-2200",
        "8h",
        "3h;5h",
        "den",
        "jen",
        "test",
        "Daniel",
        "Custom",
        "Clear"
      ]
    };

    // Make lists editable - users can modify them through the Manage Lists modal
    const lists = {
      sites: [...ORIGINAL_LISTS.sites],
      instructors: [...ORIGINAL_LISTS.instructors],
      schedule: [...ORIGINAL_LISTS.schedule]
    };

    // Toast Notifications
    function showToast(message, type = 'info') {
      const toast = document.createElement('div');
      toast.className = `toast toast-${type}`;
      toast.innerHTML = `
        <div class="toast-content">
          <span class="toast-message">${message}</span>
        </div>
      `;
      document.querySelector('.toast-container').appendChild(toast);
      
      setTimeout(() => {
        toast.style.opacity = '0';
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    // Utility Functions
    function monthToNum(abbr) {
      const map = {JAN:1,FEB:2,MAR:3,APR:4,MAY:5,JUN:6,JUL:7,AUG:8,SEP:9,OCT:10,NOV:11,DEC:12};
      return map[(abbr||'').toUpperCase()]||NaN;
    }

    function calcDaysInMonth(year, abbr) {
      const m = monthToNum(abbr);
      return isNaN(m) ? 30 : new Date(year, m, 0).getDate();
    }

    function weekday(year, abbr, day) {
      const m = monthToNum(abbr);
      if(isNaN(m)) {
        // If no valid month, calculate based on current date
        const currentDate = new Date();
        const startOfMonth = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
        const firstDayOfMonth = startOfMonth.getDay(); // 0 = Sunday, 6 = Saturday
        const dayIndex = (firstDayOfMonth + (day - 1)) % 7;
        const labels = ["SUN","MON","TUE","WED","THU","FRI","SAT"];
        return labels[dayIndex];
      }
      return new Date(year, m-1, day).toLocaleDateString(undefined,{weekday:'short'}).toUpperCase();
    }

    // Grid Functions
    function ensureGroup(day, co, idx) {
      if(!state.data[day]) state.data[day] = {};
      if(!state.data[day][co]) state.data[day][co] = [];
      if(!state.data[day][co][idx]) state.data[day][co][idx] = {site:'', instructor:'', schedule:''};
      return state.data[day][co][idx];
    }

    function createSelect(opts, val, onChange) {
      const sel = document.createElement('select');
      sel.className = 'table-select';
      opts.forEach(v => {
        const o = document.createElement('option');
        o.value = o.textContent = v;
        // Make Custom and Clear options bold
        if (v === 'Custom' || v === 'Clear') {
          o.style.fontWeight = 'bold';
        }
        sel.appendChild(o);
      });
      if(val && !opts.includes(val)) {
        const o = document.createElement('option');
        o.value = o.textContent = val;
        sel.appendChild(o);
      }
      sel.value = val || '';
      sel.onchange = () => {
        const selectedValue = sel.value;
        
        // Handle special "Clear" option
        if (selectedValue === 'Clear') {
          onChange('');
          sel.value = '';
          autoSave();
          return;
        }
        
        // Handle special "Custom" option
        if (selectedValue === 'Custom') {
          const customValue = prompt('Enter custom value:');
          if (customValue !== null && customValue.trim() !== '') {
            const trimmedValue = customValue.trim();
            
            // Add custom value to dropdown if not already present
            if (!opts.includes(trimmedValue)) {
              const customOption = document.createElement('option');
              customOption.value = customOption.textContent = trimmedValue;
              // Insert before "Custom" and "Clear" options
              const customOptionIndex = Array.from(sel.options).findIndex(opt => opt.value === 'Custom');
              if (customOptionIndex > 0) {
                sel.insertBefore(customOption, sel.options[customOptionIndex]);
              } else {
                sel.appendChild(customOption);
              }
            }
            
            onChange(trimmedValue);
            sel.value = trimmedValue;
          } else {
            // User cancelled or entered empty value, revert to previous value
            sel.value = val || '';
          }
          autoSave();
          return;
        }
        
        // Handle normal selection
        onChange(selectedValue);
        autoSave();
      };
      return sel;
    }

    // Render Calendar Grid
    function render() {
      const wrap = document.getElementById('tableWrap');
      wrap.innerHTML = '';
      
      const tbl = document.createElement('table');

      // Column groups for fixed widths
      const colg = document.createElement('colgroup');
      const c1 = document.createElement('col');
      c1.className = 'col-item';
      colg.appendChild(c1);
      
      const c2 = document.createElement('col');
      c2.className = 'col-month';
      colg.appendChild(c2);
      
      state.cohorts.forEach(() => {
        const cc = document.createElement('col');
        cc.className = 'col-cohort';
        colg.appendChild(cc);
      });
      tbl.appendChild(colg);

      // Header row
      const thead = document.createElement('thead');
      const trh = document.createElement('tr');
      
      const th1 = document.createElement('th');
      th1.textContent = "ITEM #";
      th1.className = 'sticky-col sticky-col-1';
      trh.appendChild(th1);
      
      const th2 = document.createElement('th');
      th2.textContent = state.monthAbbrev || "Month";
      th2.className = 'sticky-col sticky-col-2';
      trh.appendChild(th2);
      
      state.cohorts.forEach(co => {
        const th = document.createElement('th');
        th.textContent = co;
        trh.appendChild(th);
      });
      
      thead.appendChild(trh);
      tbl.appendChild(thead);

      // Table body
      const tbody = document.createElement('tbody');
      const filter = document.getElementById('search').value.toLowerCase();
      let item = 1;

      for(let day = 1; day <= state.daysInMonth; day++) {
        const dayText = `${day} - ${weekday(state.year, state.monthAbbrev, day)}`;
        
        for(let g = 0; g < state.groupsPerDay; g++) {
          // Sites row
          let tr = document.createElement('tr');
          let td = document.createElement('td');
          td.textContent = item++;
          td.className = 'sticky-col sticky-col-1';
          tr.appendChild(td);
          
          td = document.createElement('td');
          td.textContent = dayText;
          td.className = 'sticky-col sticky-col-2';
          tr.appendChild(td);
          
          state.cohorts.forEach(co => {
            const rec = ensureGroup(day, co, g);
            const ctd = document.createElement('td');
            ctd.appendChild(createSelect(lists.sites, rec.site, v => rec.site = v));
            tr.appendChild(ctd);
          });
          tbody.appendChild(tr);

          // Faculty row
          tr = document.createElement('tr');
          td = document.createElement('td');
          td.textContent = item++;
          td.className = 'sticky-col sticky-col-1';
          tr.appendChild(td);
          
          td = document.createElement('td');
          td.textContent = dayText;
          td.className = 'sticky-col sticky-col-2';
          tr.appendChild(td);
          
          state.cohorts.forEach(co => {
            const rec = ensureGroup(day, co, g);
            const ctd = document.createElement('td');
            ctd.appendChild(createSelect(lists.instructors, rec.instructor, v => rec.instructor = v));
            tr.appendChild(ctd);
          });
          tbody.appendChild(tr);

          // Schedule row
          tr = document.createElement('tr');
          td = document.createElement('td');
          td.textContent = item++;
          td.className = 'sticky-col sticky-col-1';
          tr.appendChild(td);
          
          td = document.createElement('td');
          td.textContent = dayText;
          td.className = 'sticky-col sticky-col-2';
          tr.appendChild(td);
          
          state.cohorts.forEach(co => {
            const rec = ensureGroup(day, co, g);
            const ctd = document.createElement('td');
            ctd.appendChild(createSelect(lists.schedule, rec.schedule, v => rec.schedule = v));
            tr.appendChild(ctd);
          });
          tbody.appendChild(tr);

          // Separator row
          tr = document.createElement('tr');
          tr.className = 'group-sep';
          td = document.createElement('td');
          td.textContent = item++;
          td.className = 'sticky-col sticky-col-1';
          tr.appendChild(td);
          
          td = document.createElement('td');
          td.textContent = dayText;
          td.className = 'sticky-col sticky-col-2';
          tr.appendChild(td);
          
          state.cohorts.forEach(() => {
            const ctd = document.createElement('td');
            ctd.textContent = '';
            tr.appendChild(ctd);
          });
          tbody.appendChild(tr);
        }
      }

      tbl.appendChild(tbody);
      wrap.appendChild(tbl);

      if (filter) {
        Array.from(tbody.rows).forEach(row => {
          const text = row.textContent.toLowerCase();
          row.style.display = text.includes(filter) ? '' : 'none';
        });
      }

      // Update statistics information panel
      updateStatistics();
    }

    // Update Statistics Information Panel
    function updateStatistics() {
      // Calculate total rows (each day has groupsPerDay * 4 rows: sites, faculty, schedule, separator)
      const totalRows = state.daysInMonth * state.groupsPerDay * 4;
      
      // Calculate data entries (non-empty values in the schedule data)
      let dataEntries = 0;
      for (let day = 1; day <= state.daysInMonth; day++) {
        for (let g = 0; g < state.groupsPerDay; g++) {
          state.cohorts.forEach(cohort => {
            const rec = ensureGroup(day, cohort, g);
            if (rec.site && rec.site.trim() !== '') dataEntries++;
            if (rec.instructor && rec.instructor.trim() !== '') dataEntries++;
            if (rec.schedule && rec.schedule.trim() !== '') dataEntries++;
          });
        }
      }

      const totalDays = state.daysInMonth;
      const totalCohorts = state.cohorts.length;

      // Update the display
      document.getElementById('totalRows').textContent = totalRows;
      document.getElementById('dataEntries').textContent = dataEntries;
      document.getElementById('totalDays').textContent = totalDays;
      document.getElementById('totalCohorts').textContent = totalCohorts;
    }

    // Import/Export Functions
    function exportCsv() {
      const rows = [];
      rows.push(["ITEM #", state.monthAbbrev||"Month", ...state.cohorts]);
      
      let item = 1;
      for(let day = 1; day <= state.daysInMonth; day++) {
        const dayText = `${day} - ${weekday(state.year,state.monthAbbrev,day)}`;
        for(let g = 0; g < state.groupsPerDay; g++) {
          rows.push([item++, dayText, ...state.cohorts.map(co => state.data[day]?.[co]?.[g]?.site || "")]);
          rows.push([item++, dayText, ...state.cohorts.map(co => state.data[day]?.[co]?.[g]?.instructor || "")]);
          rows.push([item++, dayText, ...state.cohorts.map(co => state.data[day]?.[co]?.[g]?.schedule || "")]);
          rows.push([item++, dayText, ...state.cohorts.map(_ => "")]);
        }
      }
      
      const csv = rows.map(r => r.map(v => `"${String(v).replace(/"/g,'""')}"`).join(",")).join("\n");
      const blob = new Blob([csv], {type: 'text/csv'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `Calendar_${state.monthAbbrev||'CAL'}_${state.year}.csv`;
      a.click();
      URL.revokeObjectURL(url);
      showToast('CSV exported successfully', 'success');
    }

    function exportXlsx() {
      // Create workbook first
      const wb = XLSX.utils.book_new();
      
      // Create worksheet data array
      const wsData = [];
      
      // Header row
      const headerRow = [state.monthAbbrev || "Month", ...state.cohorts];
      wsData.push(headerRow);
      
      // Add data rows
      for(let day = 1; day <= state.daysInMonth; day++) {
        const dayText = `${day} - ${weekday(state.year, state.monthAbbrev, day)}`;
        
        for(let g = 0; g < state.groupsPerDay; g++) {
          // Check if group has any data
          let hasData = false;
          for(const cohort of state.cohorts) {
            const data = state.data[day]?.[cohort]?.[g] || {};
            if(data.site || data.instructor || data.schedule) {
              hasData = true;
              break;
            }
          }
          
          // Skip empty groups entirely
          if(!hasData) {
            continue;
          }
          
          // Sites row
          const sitesRow = [dayText];
          state.cohorts.forEach(cohort => {
            const siteValue = state.data[day]?.[cohort]?.[g]?.site || "";
            sitesRow.push(siteValue);
          });
          wsData.push(sitesRow);
          
          // Faculty row
          const facultyRow = [dayText];
          state.cohorts.forEach(cohort => {
            const instructorValue = state.data[day]?.[cohort]?.[g]?.instructor || "";
            facultyRow.push(instructorValue);
          });
          wsData.push(facultyRow);
          
          // Schedule row
          const scheduleRow = [dayText];
          state.cohorts.forEach(cohort => {
            const scheduleValue = state.data[day]?.[cohort]?.[g]?.schedule || "";
            scheduleRow.push(scheduleValue);
          });
          wsData.push(scheduleRow);
          
          // Add empty row for spacing
          wsData.push(Array(state.cohorts.length + 1).fill(""));
        }
      }
      
      // Create worksheet from data
      const ws = XLSX.utils.aoa_to_sheet(wsData);
      
      // Apply styling manually to each cell
      const range = XLSX.utils.decode_range(ws['!ref']);
      
      // Style header row (row 0)
      for(let c = range.s.c; c <= range.e.c; c++) {
        const cellAddress = XLSX.utils.encode_cell({r: 0, c: c});
        if(ws[cellAddress]) {
          ws[cellAddress].s = {
            fill: { fgColor: { rgb: "4472C4" } },
            font: { color: { rgb: "FFFFFF" }, bold: true, sz: 14 },
            alignment: { horizontal: "center", vertical: "center" },
            border: {
              top: { style: "medium", color: { rgb: "000000" } },
              bottom: { style: "medium", color: { rgb: "000000" } },
              left: { style: "medium", color: { rgb: "000000" } },
              right: { style: "medium", color: { rgb: "000000" } }
            }
          };
        }
      }
      
      // Style data rows
      for(let r = 1; r <= range.e.r; r++) {
        for(let c = range.s.c; c <= range.e.c; c++) {
          const cellAddress = XLSX.utils.encode_cell({r: r, c: c});
          if(ws[cellAddress] && ws[cellAddress].v !== "") {
            if(c === 0) {
              // Day header column styling
              ws[cellAddress].s = {
                fill: { fgColor: { rgb: "E8F4FD" } },
                font: { bold: true, sz: 11 },
                alignment: { horizontal: "center", vertical: "center" },
                border: {
                  top: { style: "thin", color: { rgb: "B0B0B0" } },
                  bottom: { style: "thin", color: { rgb: "B0B0B0" } },
                  left: { style: "thin", color: { rgb: "B0B0B0" } },
                  right: { style: "thin", color: { rgb: "B0B0B0" } }
                }
              };
            } else {
              // Data cells styling
              ws[cellAddress].s = {
                font: { sz: 11 },
                alignment: { horizontal: "center", vertical: "center" },
                border: {
                  top: { style: "thin", color: { rgb: "D0D0D0" } },
                  bottom: { style: "thin", color: { rgb: "D0D0D0" } },
                  left: { style: "thin", color: { rgb: "D0D0D0" } },
                  right: { style: "thin", color: { rgb: "D0D0D0" } }
                }
              };
            }
          }
        }
      }
      
      // Set column widths
      const colWidths = [{ wch: 18 }]; // Month/Date column
      state.cohorts.forEach(() => {
        colWidths.push({ wch: 15 }); // Cohort columns
      });
      ws['!cols'] = colWidths;
      
      // Set row heights
      const rowHeights = [];
      for (let i = 0; i <= range.e.r; i++) {
        if (i === 0) {
          rowHeights.push({ hpt: 25 }); // Header row taller
        } else {
          // Check if it's an empty row
          let isEmpty = true;
          for(let c = range.s.c; c <= range.e.c; c++) {
            const cellAddress = XLSX.utils.encode_cell({r: i, c: c});
            if(ws[cellAddress] && ws[cellAddress].v !== "") {
              isEmpty = false;
              break;
            }
          }
          if(isEmpty) {
            rowHeights.push({ hpt: 8 }); // Empty rows minimal height
          } else {
            rowHeights.push({ hpt: 20 }); // Regular rows
          }
        }
      }
      ws['!rows'] = rowHeights;
      
      // Add worksheet to workbook
      XLSX.utils.book_append_sheet(wb, ws, `${state.monthAbbrev || 'CAL'} ${state.year}`);
      
      // Export with styling
      XLSX.writeFile(wb, `Calendar_${state.monthAbbrev || 'CAL'}_${state.year}.xlsx`);
      showToast('Professional XLSX exported with blue headers and borders', 'success');
    }

    // Export Normalized CSV (matching the raw_export_preview format)
    function exportNormalizedCsv() {
      const rows = [];
      
      // Header row matching the CSV format
      rows.push(['#', 'Date', 'Site', 'Cohort', 'Faculty', 'Schedule', 'Hours', 'Comments', 'Validation Notes']);
      
      let sequenceNumber = 1;
      
      for(let day = 1; day <= state.daysInMonth; day++) {
        const dayText = `${day} - ${weekday(state.year, state.monthAbbrev, day)}`;
        
        for(let g = 0; g < state.groupsPerDay; g++) {
          for(const cohort of state.cohorts) {
            const data = state.data[day]?.[cohort]?.[g] || {};
            
            // Only export rows that have at least site, instructor, or schedule data
            if(data.site || data.instructor || data.schedule) {
              // Calculate hours from schedule if available
              let hours = '';
              let validationNotes = '';
              
              if(data.schedule) {
                // Try to extract hours from common schedule patterns
                if(data.schedule.includes('h')) {
                  // Direct hour notation like "8h", "5.5h"
                  const hourMatch = data.schedule.match(/(\d+(?:\.\d+)?)\s*h/);
                  if(hourMatch) {
                    hours = hourMatch[1];
                  }
                } else if(data.schedule.includes('-')) {
                  // Time range like "0700-1530"
                  const timeMatch = data.schedule.match(/(\d{4})-(\d{4})/);
                  if(timeMatch) {
                    const startTime = parseInt(timeMatch[1]);
                    const endTime = parseInt(timeMatch[2]);
                    
                    // Convert to hours (simple calculation)
                    const startHour = Math.floor(startTime / 100) + (startTime % 100) / 60;
                    const endHour = Math.floor(endTime / 100) + (endTime % 100) / 60;
                    let duration = endHour - startHour;
                    
                    // Handle overnight shifts
                    if(duration < 0) {
                      duration += 24;
                    }
                    
                    hours = duration.toString();
                  }
                }
              }
              
              // Validation checks
              if((data.site && !data.instructor) || (!data.site && data.instructor)) {
                validationNotes = 'Incomplete. Wrong Data Entry. Please fix the source table and click on Export Raw CSV again.';
              } else if(data.schedule && (!data.site || !data.instructor)) {
                validationNotes = 'Incomplete. Wrong Data Entry. Please fix the source table and click on Export Raw CSV again.';
              }
              
              rows.push([
                sequenceNumber.toString(),
                dayText,
                data.site || '',
                cohort,
                data.instructor || '',
                data.schedule || '',
                hours,
                '', // Comments (empty for now, can be extended)
                validationNotes
              ]);
            }
          }
        }
        
        // Increment sequence number for each day (matching the pattern in your CSV)
        sequenceNumber += 4; // This matches the pattern in your sample CSV
      }
      
      // Convert to CSV format
      const csv = rows.map(row => 
        row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(',')
      ).join('\n');
      
      // Download the file
      const blob = new Blob([csv], {type: 'text/csv'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `Normalized_Export_${state.monthAbbrev||'CAL'}_${state.year}.csv`;
      a.click();
      URL.revokeObjectURL(url);
      
      showToast('Normalized CSV exported successfully', 'success');
    }

    // Modal Functions
    function openLists() {
      // Show only editable options (exclude protected Custom/Clear and empty string)
      const editableSites = lists.sites.filter(item => item !== '' && item !== 'Custom' && item !== 'Clear');
      const editableInstructors = lists.instructors.filter(item => item !== '' && item !== 'Custom' && item !== 'Clear');
      const editableSchedule = lists.schedule.filter(item => item !== '' && item !== 'Custom' && item !== 'Clear');
      
      document.getElementById('sitesInput').value = editableSites.join("\n");
      document.getElementById('instInput').value = editableInstructors.join("\n");
      document.getElementById('timesInput').value = editableSchedule.join("\n");
      document.getElementById('listsModal').style.display = 'block';
    }

    function saveLists() {
      // Get the text from the textareas and split into arrays
      const sitesText = document.getElementById('sitesInput').value;
      const instText = document.getElementById('instInput').value;
      const scheduleText = document.getElementById('timesInput').value;
      
      // Update the lists with new values, filtering out protected options
      lists.sites = sitesText.split('\n')
        .map(item => item.trim())
        .filter(item => item !== '' && item !== 'Custom' && item !== 'Clear');
      lists.instructors = instText.split('\n')
        .map(item => item.trim())
        .filter(item => item !== '' && item !== 'Custom' && item !== 'Clear');
      lists.schedule = scheduleText.split('\n')
        .map(item => item.trim())
        .filter(item => item !== '' && item !== 'Custom' && item !== 'Clear');
      
      // Ensure empty string is always first option
      lists.sites.unshift('');
      lists.instructors.unshift('');
      lists.schedule.unshift('');
      
      // PROTECTED: Always ensure Custom and Clear are at the end - these cannot be removed
      lists.sites.push('Custom', 'Clear');
      lists.instructors.push('Custom', 'Clear');
      lists.schedule.push('Custom', 'Clear');
      
      // Close modal and re-render
      document.getElementById('listsModal').style.display = 'none';
      render();
      
      // Auto-save the updated lists
      autoSave();
      
      showToast('Lists updated successfully (Custom/Clear options are protected)', 'success');
    }

    function closeLists() {
      document.getElementById('listsModal').style.display = 'none';
    }

    // Column Management Functions
    function openColumns() {
      document.getElementById('columnsInput').value = state.cohorts.join("\n");
      document.getElementById('columnsModal').style.display = 'block';
    }

    function saveColumns() {
      const columnsText = document.getElementById('columnsInput').value;
      const newCohorts = columnsText.split('\n')
        .map(item => item.trim())
        .filter(item => item !== '');
      
      if (newCohorts.length === 0) {
        showToast('At least one cohort/column is required', 'error');
        return;
      }
      
      // Store old data before updating cohorts
      const oldData = JSON.parse(JSON.stringify(state.data));
      
      // Update cohorts
      state.cohorts = newCohorts;
      
      // Migrate existing data to new cohort structure
      const newData = {};
      for (let day = 1; day <= state.daysInMonth; day++) {
        if (oldData[day]) {
          newData[day] = {};
          for (const cohort of state.cohorts) {
            if (oldData[day][cohort]) {
              // Preserve existing data for cohorts that still exist
              newData[day][cohort] = oldData[day][cohort];
            } else {
              // Initialize new cohorts with empty groups
              newData[day][cohort] = Array(4).fill().map(() => ({site: '', instructor: '', schedule: ''}));
            }
          }
        }
      }
      
      state.data = newData;
      
      // Close modal and re-render
      document.getElementById('columnsModal').style.display = 'none';
      render();
      
      // Auto-save the updated structure
      autoSave();
      
      showToast(`Columns updated successfully (${state.cohorts.length} cohorts)`, 'success');
    }

    function resetColumns() {
      if (confirm('Reset to default cohorts? This will restore the original column layout.\n\nExisting data for current cohorts will be preserved where possible.')) {
        const defaultCohorts = ["VN B111 (D)","VN B113 (D)","VN B108 (D)","VN B112 (E)","VN B107 (E)","VN B109 (E)","VN B103","VN B110 (10)","NATP/HHA","RN-BSN","Make Up","Admin"];
        document.getElementById('columnsInput').value = defaultCohorts.join("\n");
        showToast('Reset to default cohorts - click Save Changes to apply', 'info');
      }
    }

    function closeColumns() {
      document.getElementById('columnsModal').style.display = 'none';
    }

    // Fullscreen Functions
    async function toggleFullscreen() {
      if (!document.fullscreenElement) {
        document.body.classList.add('fullscreen');
        await document.documentElement.requestFullscreen?.();
        document.getElementById('toggleFullBtn').textContent = 'Exit Full Screen';
      } else {
        await document.exitFullscreen?.();
      }
    }

    document.addEventListener('fullscreenchange', () => {
      if (!document.fullscreenElement) {
        document.body.classList.remove('fullscreen');
        document.getElementById('toggleFullBtn').textContent = 'Enter Full Screen';
      }
    });

    // Admin Functions
    function enableAdminFeatures() {
      document.body.classList.add('admin-mode');
      showToast('Admin mode enabled', 'info');
    }

    // Event Listeners
    document.getElementById('applyCal').addEventListener('click', () => {
      const abbr = (document.getElementById('monthAbbrev').value || '').trim().toUpperCase();
      const yr = parseInt(document.getElementById('yearInput').value || String(state.year), 10);
      
      // Validate month abbreviation
      const validMonths = ['JAN','FEB','MAR','APR','MAY','JUN','JUL','AUG','SEP','OCT','NOV','DEC'];
      if (!validMonths.includes(abbr)) {
        showToast('Please enter a valid month (e.g., JAN, FEB)', 'error');
        return;
      }
      
      // Validate year
      if (isNaN(yr) || yr < 2000 || yr > 2100) {
        showToast('Please enter a valid year between 2000 and 2100', 'error');
        return;
      }
      
      // Update state
      state.monthAbbrev = abbr;
      state.year = yr;
      state.daysInMonth = calcDaysInMonth(yr, abbr);
      
      // Preserve existing data for the new month
      const oldData = state.data;
      state.data = {};
      
      // Transfer any existing data to new month structure
      for (let day = 1; day <= state.daysInMonth; day++) {
        if (oldData[day]) {
          state.data[day] = oldData[day];
        }
      }
      
      render();
      
      // Auto-save calendar changes
      autoSave();
      
      showToast(`Calendar updated to ${abbr} ${yr}`, 'success');
    });

    document.getElementById('toggleFullBtn').addEventListener('click', toggleFullscreen);
    document.getElementById('manageDropdowns').addEventListener('click', openLists);
    document.getElementById('saveLists').addEventListener('click', saveLists);
    document.getElementById('closeLists').addEventListener('click', closeLists);
    document.getElementById('manageColumns').addEventListener('click', openColumns);
    document.getElementById('saveColumns').addEventListener('click', saveColumns);
    document.getElementById('resetColumns').addEventListener('click', resetColumns);
    document.getElementById('closeColumns').addEventListener('click', closeColumns);
    // Enhanced search functionality
    const searchInput = document.getElementById('search');
    const clearButton = document.getElementById('searchClear');
    const resultsInfo = document.getElementById('searchResults');
    
    function updateSearchResults() {
      const searchTerm = searchInput.value.toLowerCase().trim();
      const rows = document.querySelectorAll('#calendar tbody tr');
      let visibleCount = 0;
      let totalCount = rows.length;
      
      if (searchTerm === '') {
        resultsInfo.textContent = '';
        resultsInfo.classList.remove('active');
        clearButton.style.display = 'none';
      } else {
        rows.forEach(row => {
          if (row.style.display !== 'none') {
            visibleCount++;
          }
        });
        resultsInfo.textContent = `Showing ${visibleCount} of ${totalCount} entries`;
        resultsInfo.classList.add('active');
        clearButton.style.display = 'block';
      }
    }
    
    searchInput.addEventListener('input', function() {
      render();
      setTimeout(updateSearchResults, 50); // Small delay to ensure render is complete
    });
    
    // Clear search functionality
    clearButton.addEventListener('click', function() {
      searchInput.value = '';
      render();
      searchInput.focus();
      updateSearchResults();
    });
    
    // Enhanced keyboard navigation
    searchInput.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        searchInput.value = '';
        render();
        updateSearchResults();
      }
    });
    document.getElementById('exportCsvBtn').addEventListener('click', exportCsv);
    document.getElementById('exportXlsxBtn').addEventListener('click', exportXlsx);
    document.getElementById('exportNormalizedCsvBtn').addEventListener('click', exportNormalizedCsv);

    document.getElementById('saveBtn')?.addEventListener('click', () => {
      localStorage.setItem('sched_state_v9', JSON.stringify(state));
      localStorage.setItem('sched_lists_v9', JSON.stringify(lists));
      showToast('Data saved successfully', 'success');
    });

    document.getElementById('restoreBtn')?.addEventListener('click', () => {
      try {
        const s = JSON.parse(localStorage.getItem('sched_state_v9')||'null');
        const l = JSON.parse(localStorage.getItem('sched_lists_v9')||'null');
        if(s) state = s;
        if(l) lists = l;
        render();
        showToast('Data restored successfully', 'success');
      } catch {
        showToast('Failed to restore data', 'error');
      }
    });

    // Import Functions
    function handleImport(file) {
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, {type: 'array'});
          const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
          const rows = XLSX.utils.sheet_to_json(firstSheet, {header: 1});
          
          // Normalize text function
          function _norm(x) { 
            return String(x == null ? '' : x).replace(/\u00A0/g, ' ').replace(/\s+/g, ' ').trim(); 
          }

          // Find header row with improved detection
          const MONTH_RX = /(^|\b)(month|jan|feb|mar|apr|may|jun|jul|aug|sep|oct|nov|dec|day|date)\b/i;
          const ITEM_RX = /(^|\b)item\s*#?\b/i;
          let headerRow = -1, itemIdx = -1, monthIdx = -1, header = null;

          for(let r = 0; r < Math.min(60, rows.length); r++) {
            const row = (rows[r] || []).map(_norm);
            const i = row.findIndex(h => ITEM_RX.test(h));
            if(i !== -1) {
              let m = row.findIndex(h => MONTH_RX.test(h));
              if(m === -1) {
                m = row.findIndex(h => /^(jan|feb|mar|apr|may|jun|jul|aug|sep|oct|nov|dec)$/i.test(h));
              }
              if(m !== -1) {
                headerRow = r;
                itemIdx = i;
                monthIdx = m;
                header = row;
                break;
              }
            }
          }

          if(headerRow < 0) {
            showToast('Could not locate the header row. Need "ITEM #" and Month/Day.', 'error');
            return;
          }

          // Parse cohorts (all headers except ITEM & Month)
          const cohorts = header
            .map((h, i) => ({h: _norm(h), i}))
            .filter(x => x.i !== itemIdx && x.i !== monthIdx && x.h)
            .map(x => x.h);

          if(!cohorts.length) {
            showToast('No cohort columns found in file', 'error');
            return;
          }

          // Update state with new cohorts
          state.cohorts = cohorts.slice();
          state.data = {};

          // Get current month/year context
          const monAbbr = (document.getElementById('monthAbbrev').value || 'NOV').toUpperCase().slice(0, 3);
          const yearVal = parseInt(document.getElementById('yearInput').value || '2025', 10) || 2025;
          const maxDays = calcDaysInMonth(yearVal, monAbbr);

          // Setup column index mapping
          const colIndex = Object.fromEntries(cohorts.map(c => [c, header.indexOf(c)]));
          
          // Initialize data structure
          for(let d = 1; d <= maxDays; d++) {
            state.data[d] = {};
            for(const c of cohorts) {
              state.data[d][c] = Array(4).fill().map(() => ({site: '', instructor: '', schedule: ''}));
            }
          }

          // Helper function to append values
          function append(prev, val) {
            if(!val) return prev;
            return prev ? (prev + ' | ' + val) : val;
          }

          // Parse data rows with improved handling
          let currentDay = 1;
          const groupIdx = {};
          for(let d = 1; d <= maxDays; d++) { groupIdx[d] = 0; }

          for(let r = headerRow + 1; r < rows.length; r++) {
            const row = rows[r] || [];
            
            // Update day when found in month column
            const dcell = _norm(row[monthIdx]);
            const dm = dcell.match(/(\d{1,2})/);
            if(dm) {
              currentDay = parseInt(dm[1], 10);
            }
            if(!currentDay || currentDay < 1 || currentDay > maxDays) continue;

            // Parse item number and determine row type
            const iraw = _norm(row[itemIdx]);
            if(!iraw) continue;
            const inum = parseInt(iraw.replace(/[^0-9]/g, ''), 10);
            if(!inum) continue;
            const mod = inum % 4; // 1=site, 2=instructor, 3=schedule, 0=separator

            if(mod === 0) {
              groupIdx[currentDay] = Math.min(3, groupIdx[currentDay] + 1);
              continue;
            }

            // Get current group index
            const g = Math.min(groupIdx[currentDay], 3);

            // Process each cohort's data
            for(const c of cohorts) {
              const ci = colIndex[c];
              const val = (ci >= 0 && ci < row.length) ? _norm(row[ci]) : '';
              if(!val) continue;

              const rec = state.data[currentDay][c][g];
              
              if(mod === 1) {
                rec.site = append(rec.site, val);
              } else if(mod === 2) {
                rec.instructor = append(rec.instructor, val);
              } else if(mod === 3) {
                rec.schedule = append(rec.schedule, val);
              }
            }
          }

          // DON'T ADD ANYTHING TO DROPDOWN LISTS FROM IMPORT
          // Keep the original dropdown lists exactly as they are

          // Update month/year inputs to match imported data if needed
          const firstMonthCell = rows[headerRow + 1]?.[monthIdx];
          if(firstMonthCell) {
            const monthMatch = firstMonthCell.toString().match(/[A-Za-z]{3}/i);
            if(monthMatch) {
              const monthAbbr = monthMatch[0].toUpperCase();
              document.getElementById('monthAbbrev').value = monthAbbr;
              document.getElementById('monthSelect').value = monthAbbr;
            }
          }

          render();
          
          // Auto-save imported data
          autoSave();
          
          showToast('File imported successfully', 'success');
        } catch(e) {
          console.error('Import error:', e);
          showToast('Error importing file: ' + e.message, 'error');
        }
      };
      reader.readAsArrayBuffer(file);
    }

    // Wire up import button
    document.getElementById('importXlsxBtn').addEventListener('click', () => {
      document.getElementById('fileInput').click();
    });

    document.getElementById('fileInput').addEventListener('change', (e) => {
      const file = e.target.files[0];
      if(file) {
        handleImport(file);
      }
      e.target.value = ''; // Reset input
    });

    // Admin Authentication with Session Persistence
    const ADMIN_PASSWORD = 'admin123'; // Change this to your desired password
    let isAdminMode = false;

    function showAdminAuth() {
      document.getElementById('adminAuthModal').style.display = 'block';
      document.getElementById('adminPassword').focus();
    }

    function closeAdminAuth() {
      document.getElementById('adminAuthModal').style.display = 'none';
      document.getElementById('adminPassword').value = '';
    }

    function enableAdminMode() {
      isAdminMode = true;
      document.body.classList.add('admin-mode');
      document.getElementById('adminToolbar').style.display = 'flex';
      
      // Save admin session to sessionStorage (persists through refresh, cleared when tab closes)
      sessionStorage.setItem('admin_session', 'authenticated');
      
      closeAdminAuth();
      showToast('Admin mode enabled', 'success');
    }

    function disableAdminMode() {
      isAdminMode = false;
      document.body.classList.remove('admin-mode');
      document.getElementById('adminToolbar').style.display = 'none';
      
      // Clear admin session from sessionStorage
      sessionStorage.removeItem('admin_session');
      
      showToast('Logged out of admin mode', 'info');
    }

    function checkAdminSession() {
      // Check sessionStorage for admin session (persists through refresh, cleared when tab closes)
      const adminSession = sessionStorage.getItem('admin_session');
      
      if (adminSession === 'authenticated') {
        // Restore admin mode
        isAdminMode = true;
        document.body.classList.add('admin-mode');
        document.getElementById('adminToolbar').style.display = 'flex';
        return true;
      } else {
        // Start in normal user mode
        isAdminMode = false;
        document.body.classList.remove('admin-mode');
        document.getElementById('adminToolbar').style.display = 'none';
        return false;
      }
    }

    document.getElementById('adminLoginBtn').addEventListener('click', () => {
      const password = document.getElementById('adminPassword').value;
      if (password === ADMIN_PASSWORD) {
        enableAdminMode();
      } else {
        showToast('Invalid password', 'error');
      }
    });

    document.getElementById('adminPassword').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        document.getElementById('adminLoginBtn').click();
      }
    });

    // Admin Features

    function exportValidationReport() {
      const issues = [];
      
      for (let day = 1; day <= state.daysInMonth; day++) {
        for (const cohort of state.cohorts) {
          for (let group = 0; group < 4; group++) {
            const data = state.data[day]?.[cohort]?.[group] || {};
            
            // Check for incomplete entries
            if ((data.site && !data.instructor) || (!data.site && data.instructor)) {
              issues.push(`Day ${day}, ${cohort}, Group ${group + 1}: Incomplete entry (missing site or instructor)`);
            }
            
            // Check for schedule without site/instructor
            if (data.schedule && (!data.site || !data.instructor)) {
              issues.push(`Day ${day}, ${cohort}, Group ${group + 1}: Schedule without complete assignment`);
            }
          }
        }
      }

      // Generate and download report
      const report = issues.length ? issues.join('\\n') : 'No validation issues found.';
      const blob = new Blob([report], { type: 'text/plain' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `validation_report_${state.monthAbbrev}_${state.year}.txt`;
      a.click();
      URL.revokeObjectURL(a.href);
      
      showToast(`Validation report generated with ${issues.length} issues`, 'info');
    }

    function exportIssuesCsv() {
      const issues = [];
      issues.push(['Day', 'Cohort', 'Group', 'Issue Type', 'Details']);
      
      for (let day = 1; day <= state.daysInMonth; day++) {
        for (const cohort of state.cohorts) {
          for (let group = 0; group < 4; group++) {
            const data = state.data[day]?.[cohort]?.[group] || {};
            
            if ((data.site && !data.instructor) || (!data.site && data.instructor)) {
              issues.push([day, cohort, group + 1, 'Incomplete Entry', 'Missing site or instructor']);
            }
            
            if (data.schedule && (!data.site || !data.instructor)) {
              issues.push([day, cohort, group + 1, 'Invalid Schedule', 'Schedule without complete assignment']);
            }
          }
        }
      }

      if (issues.length > 1) {
        const csv = issues.map(row => row.map(cell => `"${cell}"`).join(',')).join('\\n');
        const blob = new Blob([csv], { type: 'text/csv' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `issues_${state.monthAbbrev}_${state.year}.csv`;
        a.click();
        URL.revokeObjectURL(a.href);
        showToast(`Issues CSV exported with ${issues.length - 1} issues`, 'info');
      } else {
        showToast('No issues found to export', 'info');
      }
    }

    // Backup/Restore Functions
    function showBackupRestore() {
      updateBackupsList();
      document.getElementById('backupRestoreModal').style.display = 'block';
    }

    function closeBackupRestore() {
      document.getElementById('backupRestoreModal').style.display = 'none';
    }

    function updateBackupsList() {
      const listEl = document.getElementById('backupsList');
      const backups = [];
      
      // Get all backup keys from localStorage
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key.startsWith('scheduler_backup_')) {
          const date = key.replace('scheduler_backup_', '');
          backups.push({ key, date });
        }
      }

      // Sort backups by date (newest first)
      backups.sort((a, b) => b.date.localeCompare(a.date));

      // Generate HTML
      listEl.innerHTML = backups.map(backup => `
        <div class="backup-item">
          <span>${new Date(backup.date).toLocaleString()}</span>
          <div class="btn-group">
            <button onclick="restoreBackup('${backup.key}')" class="btn btn-secondary btn-sm">Restore</button>
            <button onclick="deleteBackup('${backup.key}')" class="btn btn-danger btn-sm">Delete</button>
          </div>
        </div>
      `).join('') || '<div class="backup-item">No backups found</div>';
    }

    function createBackup() {
      const timestamp = new Date().toISOString();
      const key = `scheduler_backup_${timestamp}`;
      const data = {
        state: { ...state },
        lists: { ...lists },
        timestamp
      };
      
      localStorage.setItem(key, JSON.stringify(data));
      updateBackupsList();
      showToast('Backup created successfully', 'success');
    }

    function restoreBackup(key) {
      try {
        const data = JSON.parse(localStorage.getItem(key));
        if (data && data.state && data.lists) {
          state = data.state;
          lists = data.lists;
          render();
          showToast('Backup restored successfully', 'success');
        }
      } catch (e) {
        showToast('Failed to restore backup', 'error');
      }
    }

    function deleteBackup(key) {
      if (confirm('Are you sure you want to delete this backup?')) {
        localStorage.removeItem(key);
        updateBackupsList();
        showToast('Backup deleted', 'info');
      }
    }

    // Clear all data function
    function clearAllData() {
      if (confirm('Are you sure you want to clear ALL data? This cannot be undone!\n\nThis will clear:\n- All schedule entries\n- All imported data\n- Month/year settings\n\nNote: Dropdown lists and cohorts/columns will be preserved.\n\nClick OK to proceed or Cancel to abort.')) {
        try {
          // Clear both localStorage and sessionStorage calendar data (but preserve lists and cohorts)
          localStorage.removeItem('sched_state_v9');
          localStorage.removeItem('sched_state_auto_v9');
          sessionStorage.removeItem('sched_state_session_v9');
          localStorage.removeItem('sched_last_save');
          
          // Preserve existing cohorts from localStorage
          const savedCohorts = localStorage.getItem('sched_cohorts_v9');
          let preservedCohorts = ["VN B111 (D)","VN B113 (D)","VN B108 (D)","VN B112 (E)","VN B107 (E)","VN B109 (E)","VN B103","VN B110 (10)","NATP/HHA","RN-BSN","Make Up","Admin"];
          
          if(savedCohorts) {
            try {
              const parsedCohorts = JSON.parse(savedCohorts);
              if(parsedCohorts && Array.isArray(parsedCohorts) && parsedCohorts.length > 0) {
                preservedCohorts = parsedCohorts;
              }
            } catch(e) {
              console.log('Could not restore saved cohorts during clear, using defaults');
            }
          }
          
          // Reset state to defaults (preserve lists and cohorts)
          state = {
            monthAbbrev: "",
            year: 2025,
            daysInMonth: 30,
            cohorts: preservedCohorts,
            groupsPerDay: 4,
            data: {}
          };
          
          // Keep existing dropdown lists intact - DO NOT reset them
          // Keep existing cohorts intact - DO NOT reset them
          
          // Reset form fields
          document.getElementById('monthAbbrev').value = "";
          document.getElementById('monthSelect').value = "";
          document.getElementById('yearInput').value = "2025";
          
          // Re-render with clean data
          render();
          
          showToast('Calendar data cleared successfully (dropdown lists and cohorts preserved)', 'success');
        } catch(e) {
          console.error('Error clearing data:', e);
          showToast('Error clearing data: ' + e.message, 'error');
        }
      }
    }

    // Wire up admin buttons
    document.getElementById('exportValidationReportBtn')?.addEventListener('click', exportValidationReport);
    document.getElementById('exportIssuesCsvBtn')?.addEventListener('click', exportIssuesCsv);
    document.getElementById('backupRestoreBtn')?.addEventListener('click', showBackupRestore);
    document.getElementById('createBackupBtn')?.addEventListener('click', createBackup);
    document.getElementById('adminLogoutBtn')?.addEventListener('click', disableAdminMode);

    // Show admin login button (floating in bottom right)
    const adminLoginFab = document.createElement('button');
    adminLoginFab.id = 'adminLoginFab';
    adminLoginFab.className = 'btn btn-primary';
    adminLoginFab.style.cssText = 'position:fixed;bottom:20px;right:20px;z-index:999;border-radius:50%;width:50px;height:50px;display:flex;align-items:center;justify-content:center;box-shadow:var(--shadow-lg);';
    adminLoginFab.innerHTML = '🔐';
    adminLoginFab.onclick = showAdminAuth;
    document.body.appendChild(adminLoginFab);

    // Admin Button Functions
    
    // Import CSV Function
    function handleCsvImport(file) {
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const text = e.target.result;
          const rows = text.split(/\\r?\\n/).map(row => 
            row.split(',').map(cell => 
              cell.replace(/^"(.*)"$/, '$1').replace(/""/g, '"').trim()
            )
          );

          // Find header row
          let headerRow = -1;
          const MONTH_RX = /(^|\b)(month|jan|feb|mar|apr|may|jun|jul|aug|sep|oct|nov|dec|day|date)\b/i;
          const ITEM_RX = /(^|\b)item\s*#?\b/i;
          
          for(let r = 0; r < Math.min(20, rows.length); r++) {
            const row = rows[r];
            const itemIdx = row.findIndex(h => ITEM_RX.test(h));
            if(itemIdx !== -1) {
              const monthIdx = row.findIndex(h => MONTH_RX.test(h));
              if(monthIdx !== -1) {
                headerRow = r;
                // Parse cohorts (all headers except ITEM & Month)
                const cohorts = row.filter((h, i) => 
                  i !== itemIdx && i !== monthIdx && h.trim()
                );
                
                if(cohorts.length) {
                  // Update state
                  state.cohorts = cohorts;
                  state.data = {};
                  
                  // Process data rows
                  let currentDay = 1;
                  let groupIndex = 0;
                  
                  for(let i = headerRow + 1; i < rows.length; i++) {
                    const row = rows[i];
                    if(!row.length) continue;
                    
                    // Check for day in month column
                    const dayMatch = row[monthIdx]?.match(/^\s*(\d+)/);
                    if(dayMatch) {
                      currentDay = parseInt(dayMatch[1], 10);
                      if(currentDay < 1 || currentDay > 31) continue;
                    }
                    
                    // Parse item number
                    const itemNum = parseInt(row[itemIdx]?.replace(/\D/g, '') || '0', 10);
                    if(!itemNum) continue;
                    
                    const rowType = itemNum % 4; // 1=site, 2=instructor, 3=schedule, 0=separator
                    
                    if(rowType === 0) {
                      groupIndex = Math.min(3, groupIndex + 1);
                      continue;
                    }
                    
                    // Process each cohort's data
                    cohorts.forEach((cohort, idx) => {
                      const value = row[idx + 2]?.trim() || '';
                      if(!value) return;
                      
                      const record = ensureGroup(currentDay, cohort, groupIndex);
                      
                      if(rowType === 1) {
                        record.site = value;
                      } else if(rowType === 2) {
                        record.instructor = value;
                      } else if(rowType === 3) {
                        record.schedule = value;
                      }
                    });
                  }
                  
                  render();
                  
                  // Auto-save imported CSV data
                  autoSave();
                  
                  showToast('CSV imported successfully', 'success');
                  return;
                }
              }
            }
          }
          throw new Error('Invalid CSV format');
        } catch(e) {
          console.error('CSV import error:', e);
          showToast('Error importing CSV: ' + e.message, 'error');
        }
      };
      reader.readAsText(file);
    }

    // Save Function - Manual save for admin users (saves both calendar data and lists)
    function saveState() {
      try {
        // Manual save for admin users - saves to both sessionStorage and localStorage
        localStorage.setItem('sched_state_v9', JSON.stringify(state)); // Permanent backup
        sessionStorage.setItem('sched_state_session_v9', JSON.stringify(state)); // Session backup
        localStorage.setItem('sched_lists_v9', JSON.stringify(lists));
        localStorage.setItem('sched_cohorts_v9', JSON.stringify(state.cohorts)); // Save cohorts permanently
        localStorage.setItem('sched_last_save', new Date().toISOString());
        
        showToast('Data saved manually (includes calendar data and cohorts)', 'success');
      } catch(e) {
        console.error('Save error:', e);
        showToast('Error saving data: ' + e.message, 'error');
      }
    }

    // Restore Function - Manual restore for admin users (restores manually saved data)
    function restoreState() {
      try {
        const savedState = localStorage.getItem('sched_state_v9');
        const savedLists = localStorage.getItem('sched_lists_v9');
        const savedCohorts = localStorage.getItem('sched_cohorts_v9');
        const lastSave = localStorage.getItem('sched_last_save');
        
        if(!savedState) {
          showToast('No manually saved calendar data found', 'error');
          return;
        }
        
        // Confirm if last save exists
        if(lastSave) {
          const lastSaveDate = new Date(lastSave).toLocaleString();
          if(!confirm(`Restore manually saved data from ${lastSaveDate}?\n\nThis will load calendar data that was explicitly saved using the Save button.`)) {
            return;
          }
        }
        
        // Restore data
        const parsedState = JSON.parse(savedState);
        const parsedLists = savedLists ? JSON.parse(savedLists) : null;
        const parsedCohorts = savedCohorts ? JSON.parse(savedCohorts) : null;
        
        if(parsedState) {
          state = parsedState;
          if(parsedLists) {
            lists = parsedLists;
          }
          if(parsedCohorts && Array.isArray(parsedCohorts)) {
            state.cohorts = parsedCohorts;
          }
          
          // Also update sessionStorage to maintain session persistence
          sessionStorage.setItem('sched_state_session_v9', JSON.stringify(state));
          localStorage.setItem('sched_cohorts_v9', JSON.stringify(state.cohorts));
          
          // Update form fields to match restored state
          if(state.monthAbbrev) {
            document.getElementById('monthAbbrev').value = state.monthAbbrev;
            document.getElementById('monthSelect').value = state.monthAbbrev;
          }
          if(state.year) {
            document.getElementById('yearInput').value = state.year;
          }
          
          render();
          showToast('Manually saved data restored successfully', 'success');
        } else {
          throw new Error('Invalid saved data');
        }
      } catch(e) {
        console.error('Restore error:', e);
        showToast('Error restoring data: ' + e.message, 'error');
      }
    }



    // Wire up admin buttons
    document.getElementById('importCsvBtn').addEventListener('click', () => {
      document.getElementById('csvFileInput').click();
    });

    document.getElementById('csvFileInput').addEventListener('change', (e) => {
      const file = e.target.files[0];
      if(file) {
        handleCsvImport(file);
      }
      e.target.value = ''; // Reset input
    });

    document.getElementById('saveBtn').addEventListener('click', saveState);
    document.getElementById('restoreBtn').addEventListener('click', restoreState);
    
    // Wire up the main clear data button (available to all users)
    document.getElementById('clearAllDataBtnMain').addEventListener('click', clearAllData);

    // Auto-save function - saves calendar data to sessionStorage and dropdown lists + cohorts to localStorage
    function autoSave() {
      try {
        // Save calendar data to sessionStorage (persists through refresh, cleared when tab closes)
        sessionStorage.setItem('sched_state_session_v9', JSON.stringify(state));
        
        // Keep dropdown lists in localStorage (permanent persistence for user customizations)
        localStorage.setItem('sched_lists_v9', JSON.stringify(lists));
        
        // Save cohorts to localStorage for permanent persistence (survives browser/file close)
        localStorage.setItem('sched_cohorts_v9', JSON.stringify(state.cohorts));
        
        localStorage.setItem('sched_last_save', new Date().toISOString());
      } catch(e) {
        console.error('Auto-save error:', e);
      }
    }

    // Auto-restore function - restores calendar data from sessionStorage and dropdown lists + cohorts from localStorage
    function autoRestore() {
      try {
        // First restore cohorts from localStorage (permanent persistence - survives browser/file close)
        const savedCohorts = localStorage.getItem('sched_cohorts_v9');
        if(savedCohorts) {
          try {
            const parsedCohorts = JSON.parse(savedCohorts);
            if(parsedCohorts && Array.isArray(parsedCohorts) && parsedCohorts.length > 0) {
              state.cohorts = parsedCohorts;
            }
          } catch(e) {
            console.log('Could not restore saved cohorts, using defaults');
          }
        }
        
        // Restore calendar data from sessionStorage (persists through refresh, cleared when tab closes)
        const savedState = sessionStorage.getItem('sched_state_session_v9');
        if(savedState) {
          try {
            const parsedState = JSON.parse(savedState);
            if(parsedState && typeof parsedState === 'object') {
              // Restore calendar state (but NOT cohorts - they come from localStorage)
              if(parsedState.monthAbbrev) state.monthAbbrev = parsedState.monthAbbrev;
              if(parsedState.year) state.year = parsedState.year;
              if(parsedState.daysInMonth) state.daysInMonth = parsedState.daysInMonth;
              if(parsedState.groupsPerDay) state.groupsPerDay = parsedState.groupsPerDay;
              if(parsedState.data) state.data = parsedState.data;
              
              // Update form fields to match restored state
              if(state.monthAbbrev) {
                document.getElementById('monthAbbrev').value = state.monthAbbrev;
                document.getElementById('monthSelect').value = state.monthAbbrev;
              }
              if(state.year) {
                document.getElementById('yearInput').value = state.year;
              }
            }
          } catch(e) {
            console.log('Could not restore saved calendar data, using defaults');
          }
        }
        
        // Preserve dropdown lists from localStorage (permanent persistence for user customizations)
        const savedLists = localStorage.getItem('sched_lists_v9');
        if(savedLists) {
          try {
            const parsedLists = JSON.parse(savedLists);
            // Only restore if it has valid structure
            if(parsedLists && parsedLists.sites && parsedLists.instructors && parsedLists.schedule) {
              lists.sites = parsedLists.sites;
              lists.instructors = parsedLists.instructors;
              lists.schedule = parsedLists.schedule;
            }
          } catch(e) {
            console.log('Could not restore saved lists, using defaults');
          }
        }
        
      } catch(e) {
        console.error('Auto-restore error:', e);
      }
    }

    // Add keyboard shortcut to access admin login (Ctrl+Shift+A or Cmd+Shift+A)
    document.addEventListener('keydown', (e) => {
      if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === 'A') {
        e.preventDefault();
        showAdminAuth();
        showToast('Admin login opened via keyboard shortcut', 'info');
      }
    });

    // Check for existing admin session on page load (always starts normal)
    checkAdminSession();

    // Auto-restore data on page load (preserves custom dropdown lists)
    autoRestore();

    // Initial render
    render();

    // ANALYTICS FUNCTIONS
    let analyticsChart = null;

    // Parse hours from schedule string (handles formats like "0700-1530", "8h", "3h;5h")
    function parseHours(schedule) {
      if (!schedule || schedule.trim() === '') return 0;
      
      schedule = schedule.trim();
      
      // Handle "Xh" format
      const hourMatch = schedule.match(/^(\d+(?:\.\d+)?)h$/);
      if (hourMatch) {
        return parseFloat(hourMatch[1]);
      }
      
      // Handle "Xh;Yh" format (sum them)
      const multiHourMatch = schedule.match(/^(\d+(?:\.\d+)?)h;(\d+(?:\.\d+)?)h$/);
      if (multiHourMatch) {
        return parseFloat(multiHourMatch[1]) + parseFloat(multiHourMatch[2]);
      }
      
      // Handle time range format "HHMM-HHMM"
      const timeMatch = schedule.match(/^(\d{4})-(\d{4})$/);
      if (timeMatch) {
        const startTime = timeMatch[1];
        const endTime = timeMatch[2];
        
        const startHour = parseInt(startTime.substring(0, 2));
        const startMin = parseInt(startTime.substring(2, 4));
        const endHour = parseInt(endTime.substring(0, 2));
        const endMin = parseInt(endTime.substring(2, 4));
        
        let totalMinutes = (endHour * 60 + endMin) - (startHour * 60 + startMin);
        
        // Handle overnight shifts
        if (totalMinutes < 0) {
          totalMinutes += 24 * 60;
        }
        
        return totalMinutes / 60;
      }
      
      return 0;
    }

    // Get all faculty members from current data
    function getAllFacultyMembers() {
      const facultySet = new Set();
      
      for (let day = 1; day <= state.daysInMonth; day++) {
        if (state.data[day]) {
          state.cohorts.forEach(cohort => {
            if (state.data[day][cohort]) {
              state.data[day][cohort].forEach(group => {
                if (group.instructor && group.instructor.trim() !== '') {
                  facultySet.add(group.instructor.trim());
                }
              });
            }
          });
        }
      }
      
      return Array.from(facultySet).sort();
    }

    // Calculate analytics data
    function calculateAnalytics(timePeriod, facultyFilter, specificFaculty, deductLunch) {
      const results = {
        facultyData: {},
        totalHours: 0,
        totalDays: 0,
        averageHoursPerDay: 0,
        workingDays: []
      };

      const lunchDeduction = deductLunch ? 0.5 : 0;
      
      // Determine date range based on time period
      let startDay = 1;
      let endDay = state.daysInMonth;
      
      if (timePeriod === 'week') {
        endDay = Math.min(7, state.daysInMonth);
      } else if (timePeriod === '2weeks') {
        endDay = Math.min(14, state.daysInMonth);
      }

      // Process each day in the range
      for (let day = startDay; day <= endDay; day++) {
        let dayHasWork = false;
        
        if (state.data[day]) {
          state.cohorts.forEach(cohort => {
            if (state.data[day][cohort]) {
              state.data[day][cohort].forEach(group => {
                if (group.instructor && group.instructor.trim() !== '' && group.schedule) {
                  const instructor = group.instructor.trim();
                  const hours = parseHours(group.schedule);
                  
                  if (hours > 0) {
                    // Apply faculty filter
                    if (facultyFilter === 'all' || 
                        (facultyFilter === 'individual' && instructor === specificFaculty)) {
                      
                      if (!results.facultyData[instructor]) {
                        results.facultyData[instructor] = {
                          totalHours: 0,
                          workingDays: 0,
                          dailyHours: {},
                          assignments: []
                        };
                      }
                      
                      const adjustedHours = Math.max(0, hours - lunchDeduction);
                      results.facultyData[instructor].totalHours += adjustedHours;
                      results.facultyData[instructor].dailyHours[day] = 
                        (results.facultyData[instructor].dailyHours[day] || 0) + adjustedHours;
                      
                      results.facultyData[instructor].assignments.push({
                        day: day,
                        cohort: cohort,
                        site: group.site || 'N/A',
                        schedule: group.schedule,
                        hours: adjustedHours
                      });
                      
                      dayHasWork = true;
                    }
                  }
                }
              });
            }
          });
        }
        
        if (dayHasWork) {
          results.workingDays.push(day);
        }
      }

      // Calculate summary statistics
      Object.keys(results.facultyData).forEach(instructor => {
        const data = results.facultyData[instructor];
        data.workingDays = Object.keys(data.dailyHours).length;
        data.averageHoursPerDay = data.workingDays > 0 ? data.totalHours / data.workingDays : 0;
        results.totalHours += data.totalHours;
      });

      results.totalDays = results.workingDays.length;
      results.averageHoursPerDay = results.totalDays > 0 ? results.totalHours / results.totalDays : 0;
      
      return results;
    }

    // Generate chart based on type and data
    function generateChart(chartType, analyticsData, analysisType) {
      const ctx = document.getElementById('dataChart').getContext('2d');
      
      // Destroy existing chart
      if (analyticsChart) {
        analyticsChart.destroy();
      }

      const facultyNames = Object.keys(analyticsData.facultyData);
      
      let chartData, chartOptions;

      if (chartType === 'bar') {
        if (analysisType === 'hours') {
          chartData = {
            labels: facultyNames,
            datasets: [{
              label: 'Total Hours',
              data: facultyNames.map(name => analyticsData.facultyData[name].totalHours),
              backgroundColor: 'rgba(59, 130, 246, 0.8)',
              borderColor: 'rgba(59, 130, 246, 1)',
              borderWidth: 1
            }]
          };
        } else if (analysisType === 'comparative') {
          chartData = {
            labels: facultyNames,
            datasets: [
              {
                label: 'Total Hours',
                data: facultyNames.map(name => analyticsData.facultyData[name].totalHours),
                backgroundColor: 'rgba(59, 130, 246, 0.8)',
                borderColor: 'rgba(59, 130, 246, 1)',
                borderWidth: 1
              },
              {
                label: 'Working Days',
                data: facultyNames.map(name => analyticsData.facultyData[name].workingDays),
                backgroundColor: 'rgba(16, 185, 129, 0.8)',
                borderColor: 'rgba(16, 185, 129, 1)',
                borderWidth: 1
              }
            ]
          };
        }
        
        chartOptions = {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: analysisType === 'comparative' ? 'Hours / Days' : 'Hours'
              }
            },
            x: {
              title: {
                display: true,
                text: 'Faculty Members'
              }
            }
          }
        };
        
        analyticsChart = new Chart(ctx, {
          type: 'bar',
          data: chartData,
          options: chartOptions
        });
      } 
      else if (chartType === 'line') {
        // Line chart showing trends over time
        const days = Array.from({length: state.daysInMonth}, (_, i) => i + 1);
        const datasets = [];
        
        if (analysisType === 'trends') {
          facultyNames.forEach((name, index) => {
            const colors = [
              'rgba(59, 130, 246, 1)',
              'rgba(16, 185, 129, 1)', 
              'rgba(245, 158, 11, 1)',
              'rgba(239, 68, 68, 1)',
              'rgba(139, 92, 246, 1)'
            ];
            
            datasets.push({
              label: name,
              data: days.map(day => analyticsData.facultyData[name]?.dailyHours[day] || 0),
              borderColor: colors[index % colors.length],
              backgroundColor: colors[index % colors.length].replace('1)', '0.1)'),
              tension: 0.4
            });
          });
        }
        
        chartData = {
          labels: days.map(day => `Day ${day}`),
          datasets: datasets
        };
        
        chartOptions = {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: 'Hours per Day'
              }
            },
            x: {
              title: {
                display: true,
                text: 'Days'
              }
            }
          }
        };
        
        analyticsChart = new Chart(ctx, {
          type: 'line',
          data: chartData,
          options: chartOptions
        });
      }
      else if (chartType === 'pie') {
        const colors = [
          'rgba(59, 130, 246, 0.8)',
          'rgba(16, 185, 129, 0.8)',
          'rgba(245, 158, 11, 0.8)',
          'rgba(239, 68, 68, 0.8)',
          'rgba(139, 92, 246, 0.8)',
          'rgba(236, 72, 153, 0.8)',
          'rgba(20, 184, 166, 0.8)',
          'rgba(251, 146, 60, 0.8)'
        ];
        
        chartData = {
          labels: facultyNames,
          datasets: [{
            data: facultyNames.map(name => analyticsData.facultyData[name].totalHours),
            backgroundColor: colors,
            borderColor: colors.map(color => color.replace('0.8', '1')),
            borderWidth: 2
          }]
        };
        
        chartOptions = {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'right'
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const label = context.label || '';
                  const value = context.parsed;
                  const total = context.dataset.data.reduce((a, b) => a + b, 0);
                  const percentage = ((value / total) * 100).toFixed(1);
                  return `${label}: ${value.toFixed(1)}h (${percentage}%)`;
                }
              }
            }
          }
        };
        
        analyticsChart = new Chart(ctx, {
          type: 'pie',
          data: chartData,
          options: chartOptions
        });
      }
      else if (chartType === 'histogram') {
        // Create histogram of hours worked
        const allHours = facultyNames.map(name => analyticsData.facultyData[name].totalHours);
        const min = Math.min(...allHours);
        const max = Math.max(...allHours);
        const binCount = Math.min(10, facultyNames.length);
        const binSize = (max - min) / binCount;
        
        const bins = [];
        const binLabels = [];
        
        for (let i = 0; i < binCount; i++) {
          const binStart = min + (i * binSize);
          const binEnd = min + ((i + 1) * binSize);
          bins.push(0);
          binLabels.push(`${binStart.toFixed(1)}-${binEnd.toFixed(1)}h`);
        }
        
        allHours.forEach(hours => {
          const binIndex = Math.min(Math.floor((hours - min) / binSize), binCount - 1);
          bins[binIndex]++;
        });
        
        chartData = {
          labels: binLabels,
          datasets: [{
            label: 'Faculty Count',
            data: bins,
            backgroundColor: 'rgba(59, 130, 246, 0.8)',
            borderColor: 'rgba(59, 130, 246, 1)',
            borderWidth: 1
          }]
        };
        
        chartOptions = {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: 'Number of Faculty'
              }
            },
            x: {
              title: {
                display: true,
                text: 'Hours Range'
              }
            }
          }
        };
        
        analyticsChart = new Chart(ctx, {
          type: 'bar',
          data: chartData,
          options: chartOptions
        });
      }
    }

    // Display analytics table and summary
    function displayAnalyticsTable(analyticsData, timePeriod) {
      const summaryDiv = document.getElementById('summaryStats');
      const tableHead = document.querySelector('#detailsTable thead');
      const tableBody = document.querySelector('#detailsTable tbody');
      
      // Summary statistics
      const facultyCount = Object.keys(analyticsData.facultyData).length;
      const avgHoursPerFaculty = facultyCount > 0 ? analyticsData.totalHours / facultyCount : 0;
      
      summaryDiv.innerHTML = `
        <div class="stat-item">
          <span>Total Faculty:</span>
          <strong>${facultyCount}</strong>
        </div>
        <div class="stat-item">
          <span>Total Hours:</span>
          <strong>${analyticsData.totalHours.toFixed(1)}h</strong>
        </div>
        <div class="stat-item">
          <span>Working Days:</span>
          <strong>${analyticsData.totalDays}</strong>
        </div>
        <div class="stat-item">
          <span>Avg Hours/Faculty:</span>
          <strong>${avgHoursPerFaculty.toFixed(1)}h</strong>
        </div>
        <div class="stat-item">
          <span>Avg Hours/Day:</span>
          <strong>${analyticsData.averageHoursPerDay.toFixed(1)}h</strong>
        </div>
      `;
      
      // Table headers
      tableHead.innerHTML = `
        <tr>
          <th>Faculty</th>
          <th>Total Hours</th>
          <th>Working Days</th>
          <th>Avg/Day</th>
        </tr>
      `;
      
      // Table body
      let tableRows = '';
      Object.keys(analyticsData.facultyData)
        .sort((a, b) => analyticsData.facultyData[b].totalHours - analyticsData.facultyData[a].totalHours)
        .forEach(faculty => {
          const data = analyticsData.facultyData[faculty];
          tableRows += `
            <tr>
              <td>${faculty}</td>
              <td>${data.totalHours.toFixed(1)}h</td>
              <td>${data.workingDays}</td>
              <td>${data.averageHoursPerDay.toFixed(1)}h</td>
            </tr>
          `;
        });
      
      tableBody.innerHTML = tableRows;
    }

    // Analytics Modal Functions
    function openAnalytics() {
      document.getElementById('analyticsModal').style.display = 'block';
      
      // Populate faculty dropdown
      const facultyDropdown = document.getElementById('specificFaculty');
      const allFaculty = getAllFacultyMembers();
      
      facultyDropdown.innerHTML = '<option value="">Select Faculty Member</option>';
      allFaculty.forEach(faculty => {
        const option = document.createElement('option');
        option.value = faculty;
        option.textContent = faculty;
        facultyDropdown.appendChild(option);
      });
    }

    function closeAnalytics() {
      document.getElementById('analyticsModal').style.display = 'none';
      if (analyticsChart) {
        analyticsChart.destroy();
        analyticsChart = null;
      }
    }

    function generateAnalytics() {
      const timePeriod = document.getElementById('timePeriod').value;
      const facultySelect = document.getElementById('facultySelect').value;
      const specificFaculty = document.getElementById('specificFaculty').value;
      const chartType = document.getElementById('chartType').value;
      const analysisType = document.getElementById('analysisType').value;
      const deductLunch = document.getElementById('deductLunch').checked;
      
      if (facultySelect === 'individual' && !specificFaculty) {
        showToast('Please select a specific faculty member for individual analysis', 'warning');
        return;
      }
      
      const analyticsData = calculateAnalytics(timePeriod, facultySelect, specificFaculty, deductLunch);
      
      if (Object.keys(analyticsData.facultyData).length === 0) {
        showToast('No data found for the selected criteria', 'warning');
        return;
      }
      
      generateChart(chartType, analyticsData, analysisType);
      displayAnalyticsTable(analyticsData, timePeriod);
      
      showToast('Analytics generated successfully', 'success');
    }

    function exportAnalytics() {
      if (!analyticsChart) {
        showToast('Please generate analytics first', 'warning');
        return;
      }
      
      const link = document.createElement('a');
      link.download = `analytics_${state.monthAbbrev}_${state.year}.png`;
      link.href = analyticsChart.toBase64Image();
      link.click();
      
      showToast('Chart exported successfully', 'success');
    }

    function clearAnalytics() {
      if (analyticsChart) {
        analyticsChart.destroy();
        analyticsChart = null;
      }
      
      document.getElementById('summaryStats').innerHTML = '';
      document.querySelector('#detailsTable thead').innerHTML = '';
      document.querySelector('#detailsTable tbody').innerHTML = '';
      
      showToast('Analytics cleared', 'info');
    }

    // Analytics Event Listeners
    document.getElementById('dataAnalyticsBtn').addEventListener('click', openAnalytics);
    document.getElementById('closeAnalytics').addEventListener('click', closeAnalytics);
    document.getElementById('generateAnalytics').addEventListener('click', generateAnalytics);
    document.getElementById('exportAnalytics').addEventListener('click', exportAnalytics);
    document.getElementById('clearAnalytics').addEventListener('click', clearAnalytics);

    // Faculty selection toggle
    document.getElementById('facultySelect').addEventListener('change', function() {
      const specificFacultySelect = document.getElementById('specificFaculty');
      specificFacultySelect.disabled = this.value !== 'individual';
    });
  </script>

  <!-- Professional ExcelJS Export Implementation -->
  <script>
  (function(){
    if (window.__professionalExcelExport) return; 
    window.__professionalExcelExport = true;

    function getTable(){ 
      var w = document.getElementById('tableWrap'); 
      return w ? w.querySelector('table') : null; 
    }
    
    function headerTexts(tbl){ 
      return Array.from(tbl.querySelectorAll('thead th')).map(function(th){ 
        return (th.textContent || '').trim(); 
      }); 
    }
    
    function rowToArray(tr){
      return Array.from(tr.children).map(function(td){
        var sel = td.querySelector && td.querySelector('select');
        if (sel) return sel.value || '';
        var input = td.querySelector && td.querySelector('input');
        if (input) return input.value || '';
        return (td.textContent || '').trim();
      });
    }
    
    function buildAOAFromDOM(){
      var tbl = getTable(); 
      if(!tbl){ 
        showToast('Export failed: calendar table not found', 'error'); 
        return null; 
      }
      var aoa = [];
      aoa.push(headerTexts(tbl));
      Array.from(tbl.querySelectorAll('tbody tr')).forEach(function(tr){ 
        aoa.push(rowToArray(tr)); 
      });
      return aoa;
    }
    
    function fullMonthName(abbr){
      var map = {
        JAN:'January', FEB:'February', MAR:'March', APR:'April', 
        MAY:'May', JUN:'June', JUL:'July', AUG:'August', 
        SEP:'September', OCT:'October', NOV:'November', DEC:'December'
      };
      abbr = (abbr || '').toUpperCase().slice(0,3);
      return map[abbr] || abbr;
    }

    function ensureExcelJS(cb){
      if (window.ExcelJS) return cb();
      var s = document.createElement('script');
      s.onload = cb;
      s.src = 'https://cdn.jsdelivr.net/npm/exceljs@4.3.0/dist/exceljs.min.js';
      document.head.appendChild(s);
    }

    function downloadBlob(data, filename, mime){
      var blob = new Blob([data], {type: mime || 'application/octet-stream'});
      var a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      setTimeout(function(){ 
        URL.revokeObjectURL(a.href); 
        a.remove(); 
      }, 400);
    }

    function professionalExcelExport(){
      var aoa = buildAOAFromDOM(); 
      if(!aoa) return;
      
      ensureExcelJS(function(){
        try{
          var ExcelJS = window.ExcelJS;
          var abbr = (document.getElementById('monthAbbrev')?.value || state.monthAbbrev || '').toUpperCase().slice(0,3) || 'NOV';
          var year = (document.getElementById('yearInput')?.value || state.year || '2025');
          var titleText = 'Nursing Schedule for ' + fullMonthName(abbr) + ' ' + year;

          var wb = new ExcelJS.Workbook();
          var ws = wb.addWorksheet('Schedule', {
            properties: { defaultRowHeight: 20 },
            views: [{ state:'frozen', xSplit:2, ySplit:2 }]
          });

          var totalCols = (aoa[0] && aoa[0].length) ? aoa[0].length : 1;

          // Title row with professional blue styling
          ws.addRow([titleText]);
          ws.mergeCells(1, 1, 1, totalCols);
          for (var c=1; c<=totalCols; c++){
            var cell = ws.getCell(1, c);
            cell.font = { bold: true, size: 18, color: { argb: 'FFFFFFFF' } };
            cell.alignment = { horizontal: 'center', vertical: 'middle' };
            cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: '4472C4' } };
            cell.border = { 
              top: {style:'medium', color:{argb:'4472C4'}}, 
              left: {style:'medium', color:{argb:'4472C4'}}, 
              bottom: {style:'medium', color:{argb:'4472C4'}}, 
              right: {style:'medium', color:{argb:'4472C4'}} 
            };
          }
          ws.getRow(1).height = 28;

          // Header row with blue background
          var header = aoa[0] || [];
          ws.addRow(header);
          for (var c=1; c<=totalCols; c++){
            var hcell = ws.getCell(2, c);
            hcell.font = { bold: true, size: 12, color: { argb: 'FFFFFFFF' } };
            hcell.alignment = { horizontal: 'center', vertical: 'middle' };
            hcell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: '4472C4' } };
            hcell.border = { 
              top: {style:'thin', color:{argb:'000000'}}, 
              left: {style:'thin', color:{argb:'000000'}}, 
              bottom: {style:'thin', color:{argb:'000000'}}, 
              right: {style:'thin', color:{argb:'000000'}} 
            };
          }
          ws.getRow(2).height = 22;

          // Body rows with professional styling
          for (var r=1; r<aoa.length; r++){
            ws.addRow(aoa[r]);
          }
          
          var bodyStart = 3;
          var bodyEnd = ws.rowCount;
          
          for (var r=bodyStart; r<=bodyEnd; r++){
            var bodyIndex = r - bodyStart;
            var isSeparatorRow = ((bodyIndex + 1) % 4 === 0);
            
            for (var c=1; c<=totalCols; c++){
              var cell = ws.getCell(r, c);
              
              if (c === 2) {
                // Day header column - light blue background
                cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'E8F4FD' } };
                cell.font = { bold: true, size: 11 };
              } else if (isSeparatorRow) {
                // Separator rows - light gray
                cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'F0F0F0' } };
              } else {
                // Regular data cells - white
                cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFFFFF' } };
                cell.font = { size: 11 };
              }
              
              cell.border = { 
                top: {style:'thin', color:{argb:'D0D0D0'}}, 
                left: {style:'thin', color:{argb:'D0D0D0'}}, 
                bottom: {style:'thin', color:{argb:'D0D0D0'}}, 
                right: {style:'thin', color:{argb:'D0D0D0'}} 
              };
              
              cell.alignment = { 
                horizontal: (c <= 2 ? 'center' : 'center'), 
                vertical: 'middle', 
                wrapText: true 
              };
            }
            
            // Set row height
            ws.getRow(r).height = isSeparatorRow ? 12 : 18;
          }

          // Column widths for optimal display
          var cols = [];
          for (var i=1; i<=totalCols; i++){
            var width = 15;
            if (i === 1) width = 8;        // ITEM # column
            else if (i === 2) width = 18;  // Month/Date column
            else width = 16;               // Cohort columns
            cols.push({ width: width });
          }
          ws.columns = cols;

          // Generate and download
          wb.xlsx.writeBuffer().then(function(buf){
            var fname = 'Professional_Schedule_' + abbr + '_' + year + '.xlsx';
            downloadBlob(buf, fname, 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet');
            showToast('Professional XLSX exported successfully with blue headers and styling', 'success');
          }).catch(function(err){
            showToast('ExcelJS export error: ' + (err && err.message ? err.message : err), 'error');
          });

        }catch(e){
          showToast('Export error: ' + (e && e.message ? e.message : e), 'error');
        }
      });
    }

    function wire(){
      var xbtn = document.getElementById('exportXlsxBtn');
      if (xbtn && !xbtn.__professionalExcelStyled){
        xbtn.__professionalExcelStyled = true;
        // Intercept the export button click to use professional styling
        xbtn.addEventListener('click', function(ev){
          try{
            ev.preventDefault();
            ev.stopImmediatePropagation();
          }catch(e){}
          setTimeout(professionalExcelExport, 10);
          return false;
        }, true);
      }
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', wire); 
    } else { 
      wire(); 
    }
  })();
  </script>
</body>
</html>
