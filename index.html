<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Nursing Faculty Scheduler â€” Month Grid Titles Updated</title>
<link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Ctext y='24' font-size='24'%3EðŸ©º%3C/text%3E%3C/svg%3E">
<!-- Libraries -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://unpkg.com/mammoth@1.6.0/mammoth.browser.min.js"></script>
<style>
:root{--bg:#f7f7fb;--card:#fff;--text:#0f172a;--muted:#6b7280;--line:#e5e7eb;--accent:#2563eb;--danger:#ef4444}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial}
.container{max-width:1200px;margin:28px auto;padding:0 16px}
.header{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;flex-wrap:wrap}
.title{margin:0 0 4px;font-size:28px;font-weight:800}
.sub{margin:0 8px 8px 0;color:var(--muted)}
.toolbar{display:flex;gap:8px;flex-wrap:wrap}
button{cursor:pointer;border:1px solid var(--line);background:#fff;padding:10px 14px;border-radius:10px;transition:transform .02s}
button:active{transform:scale(.98)}
button.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
button.danger{background:var(--danger);color:#fff;border-color:var(--danger)}
.card{background:var(--card);border:1px solid var(--line);border-radius:16px;margin:16px 0;box-shadow:0 8px 20px rgba(0,0,0,.05)}
.card header{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid var(--line)}
.card .content{padding:16px}
.grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
.col-2{grid-column:span 2}.col-3{grid-column:span 3}.col-4{grid-column:span 4}.col-6{grid-column:span 6}.col-12{grid-column:span 12}
label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
select,input[type=text],input[type=date]{width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:10px;background:#fff}
select:focus,input:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px rgba(37,99,235,.15)}
table{width:100%;border-collapse:separate;border-spacing:0;font-size:14px}
thead th{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--line);text-align:left;padding:12px;z-index:1}
tbody td{padding:12px;border-bottom:1px solid var(--line)}
tbody tr:nth-child(even){background:#fbfbfe}
.pill{display:inline-block;border:1px solid var(--line);border-radius:999px;padding:2px 8px;background:#f9fafb;font-size:12px}
.row-actions{display:flex;gap:8px;justify-content:flex-end}
.status{font-size:12px;color:var(--muted)}
.hidden{display:none!important}
.modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:flex-start;justify-content:center;padding:16px;z-index:50}
.modal{width:min(980px,96vw);background:#fff;border:1px solid var(--line);border-radius:12px;box-shadow:0 24px 48px rgba(0,0,0,.25);display:flex;flex-direction:column;max-height:90vh}
.modal header,.modal .footer{padding:12px 14px;border-bottom:1px solid var(--line)}
.modal .footer{border-top:1px solid var(--line);border-bottom:none;display:flex;gap:8px;justify-content:flex-end}
.modal .body{padding:12px;overflow:auto}
.badge{display:inline-block;padding:2px 6px;border-radius:6px;background:#eef2ff;color:#3730a3;font-size:12px;border:1px solid #c7d2fe}
.list-box{max-height:260px;overflow:auto;border:1px solid var(--line);padding:8px;border-radius:8px}
.sticky-actions{position:sticky;bottom:0;background:#fff;padding-top:8px}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <div>
      <h1 class="title">Nursing Faculty Scheduler</h1>
      <p class="sub">Stable importer (XLSX/CSV/DOCX), Month Grid with spacer lines and requested titles. Full CRUD & exports. Auto-save every 30s.</p>
      <label style="display:inline-flex;gap:8px;align-items:center;border:1px solid var(--line);padding:6px 10px;border-radius:10px;user-select:none">
        <input id="breakToggle" type="checkbox"> Deduct 0.5 hr lunch break
      </label>
      <div id="saveStatus" class="status" aria-live="polite"></div>
    </div>
    <div class="toolbar">
      <button id="importDocxBtn" class="primary" title="Import table from Word/HTML">Import DOCX/HTML</button>
      <input id="importDocxInput" class="hidden" type="file" accept=".docx,.html,.htm">
      <button id="importXlsxBtn" title="Import table from Excel/CSV">Import XLSX/CSV</button>
      <input id="importXlsxInput" class="hidden" type="file" accept=".xlsx,.csv">
      <button id="monthGridBtn">Month Grid Preview</button>
      <button id="exportCsvBtn">Export CSV</button>
      <button id="previewCsvBtn">Open CSV Preview</button>
      <button id="copyCsvBtn">Copy CSV</button>
      <button id="exportXlsxBtn">Export XLSX</button>
      <button id="manageListsBtn">Manage Lists</button>
      <button id="saveLocalBtn">Save</button>
      <button id="restoreLocalBtn">Restore</button>
      <button id="resetBtn" class="danger">Clear All</button>
    </div>
  </div>

  <div class="card">
    <header><h2>Add Schedule Entry</h2></header>
    <div class="content">
      <div class="grid">
        <div class="col-2"><label>Date</label><input id="date" type="date"></div>
        <div class="col-3"><label>Cohort</label><div style="display:flex;gap:8px"><select id="cohort"></select><input id="cohortCustom" class="hidden" type="text" placeholder="Custom cohort"></div></div>
        <div class="col-2"><label>Group</label><div style="display:flex;gap:8px"><select id="group"></select><input id="groupCustom" class="hidden" type="text" placeholder="Custom group"></div></div>
        <div class="col-3"><label>Faculty Full Name</label><div style="display:flex;gap:8px"><select id="name"></select><input id="nameCustom" class="hidden" type="text" placeholder="Custom faculty"></div></div>
        <div class="col-4"><label>Clinical Site Assignment</label><div style="display:flex;gap:8px"><select id="site"></select><input id="siteCustom" class="hidden" type="text" placeholder="Custom site"></div></div>
        <div class="col-4"><label>Schedule (Time Ranges or Duration)</label><div style="display:flex;gap:8px"><select id="times"></select><input id="timesCustom" class="hidden" type="text" placeholder="07:00-15:30, 8h, 3h;5h"></div></div>
        <div class="col-12" style="text-align:right"><button id="addBtn" class="primary">Add</button></div>
      </div>
    </div>
  </div>

  <div class="card">
    <header><h2>Schedules</h2><input id="search" placeholder="Search by date/cohort/faculty/siteâ€¦"></header>
    <div class="content" style="overflow:auto">
      <table>
        <thead><tr><th>Date</th><th>Cohort</th><th>Group</th><th>Faculty</th><th>Site</th><th>Schedule</th><th>Total Hours</th><th>Actions</th></tr></thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- Edit Modal -->
<div id="editBackdrop" class="modal-backdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true">
    <header><h3>Edit Entry</h3></header>
    <div class="body">
      <div class="grid">
        <div class="col-3"><label>Date</label><input id="editDate" type="date"></div>
        <div class="col-3"><label>Cohort</label><select id="editCohort"></select></div>
        <div class="col-3"><label>Group</label><select id="editGroup"></select></div>
        <div class="col-3"><label>Faculty</label><select id="editName"></select></div>
        <div class="col-6"><label>Site</label><select id="editSite"></select></div>
        <div class="col-6"><label>Schedule</label><select id="editTimes"></select></div>
      </div>
    </div>
    <div class="footer sticky-actions"><button id="saveEdit" class="primary">Save</button><button id="closeEdit">Cancel</button></div>
  </div>
</div>

<!-- Manage Lists Modal -->
<div id="listsBackdrop" class="modal-backdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true">
    <header><h3>Manage Dropdown Lists</h3></header>
    <div class="body">
      <div class="grid">
        <div class="col-6"><h4>Cohort</h4><div style="display:flex;gap:8px"><input id="newCohort"><button id="addCohort">Add</button></div><div id="cohortList" class="list-box"></div></div>
        <div class="col-6"><h4>Group</h4><div style="display:flex;gap:8px"><input id="newGroup"><button id="addGroup">Add</button></div><div id="groupList" class="list-box"></div></div>
        <div class="col-6"><h4>Faculty</h4><div style="display:flex;gap:8px"><input id="newName"><button id="addName">Add</button></div><div id="nameList" class="list-box"></div></div>
        <div class="col-6"><h4>Site</h4><div style="display:flex;gap:8px"><input id="newSite"><button id="addSite">Add</button></div><div id="siteList" class="list-box"></div></div>
        <div class="col-12"><h4>Schedule Templates</h4><div style="display:flex;gap:8px"><input id="newTimes"><button id="addTimes">Add</button></div><div id="timesList" class="list-box"></div></div>
      </div>
    </div>
    <div class="footer sticky-actions"><button id="saveLists" class="primary">Save</button><button id="closeLists">Close</button></div>
  </div>
</div>

<!-- Force Month/Year Modal -->
<div id="forceBackdrop" class="modal-backdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true">
    <header><h3>Confirm Month / Year</h3></header>
    <div class="body">
      <p class="status">Importer couldnâ€™t confidently detect the month/year from your sheet. Please select them.</p>
      <div class="grid">
        <div class="col-3">
          <label>Month</label>
          <select id="forceMonth">
            <option value="1">JAN</option><option value="2">FEB</option><option value="3">MAR</option><option value="4">APR</option>
            <option value="5">MAY</option><option value="6">JUN</option><option value="7">JUL</option><option value="8">AUG</option>
            <option value="9">SEP</option><option value="10" selected>OCT</option><option value="11">NOV</option><option value="12">DEC</option>
          </select>
        </div>
        <div class="col-3">
          <label>Year</label>
          <input id="forceYear" type="number" value="2025" min="2000" max="2100">
        </div>
        <div class="col-6"><div class="badge">All imported rows will use this Month/Year.</div></div>
      </div>
    </div>
    <div class="footer sticky-actions"><button id="forceOk" class="primary">Continue</button><button id="forceCancel">Cancel</button></div>
  </div>
</div>

<script>
/* ===== Canonical order + display mapping for Month Grid ===== */
const CANON_ORDER=[
  "VN B111 (D)","VN B113 (D)","VN B108 (D)","VN B112 (E)",
  "VN B107 (E)","VN B109 (E)","VN B103","VN B110 (10)",
  // Use your requested titles here (order anchor)
  "NATP/ HHA","RN-BSN MSN","Make Up Tutoring","Admin",
];
// Map different header variants to your requested display labels
const DISPLAY_TITLES_MAP=(()=>{
  const map={};
  const canonKey=s=>String(s||'').toUpperCase().replace(/\u00A0/g,' ').replace(/[â€“â€”]/g,'â€”').replace(/\s+/g,' ').replace(/[._]/g,' ').replace(/\s*\/\s*/g,' / ').trim();
  map[canonKey("NATP/HHA")]           = "NATP/ HHA";
  map[canonKey("NATP/ HHA")]          = "NATP/ HHA";
  map[canonKey("RN-BSN / MSN")]       = "RN-BSN MSN";
  map[canonKey("RN-BSN MSN")]         = "RN-BSN MSN";
  map[canonKey("Make Up / Tutoring")] = "Make Up Tutoring";
  map[canonKey("Make Up Tutoring")]   = "Make Up Tutoring";
  return {canonKey, map};
})();

/* ===== Utilities & storage ===== */
const pad=n=>String(n).padStart(2,'0');
const norm=s=>String(s??'').replace(/\u00A0/g,' ').replace(/[â€“â€”]/g,'â€”').replace(/\s+/g,' ').trim();
function splitCell(v){return String(v||'').split(/\r?\n+/).map(s=>norm(s)).filter(Boolean);}
function canonKey(s){return String(s||'').toUpperCase().replace(/\s+/g,' ').replace(/[._]/g,' ').replace(/\s*\/\s*/g,' / ').trim();}
function canonIndex(label){const k=canonKey(label);const VAR=CANON_ORDER.map(s=>canonKey(s));const i=VAR.findIndex(v=>k===v||k.startsWith(v)||v.startsWith(k)||k.includes(v)||v.includes(k));return i>=0?i:999;}
function displayLabel(label){const k=DISPLAY_TITLES_MAP.canonKey(label);return DISPLAY_TITLES_MAP.map[k] || label;}
function escapeHtml(s){return String(s??'').replace(/[&<>"]/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;"}[c]))}
const LS_ROWS='fs_rows_mgrid_titles', LS_LISTS='fs_lists_mgrid_titles';
let rows=[];
let lists=JSON.parse(localStorage.getItem(LS_LISTS)||'null')||{
  cohort:[...CANON_ORDER], /* keep existing plus your requested forms */
  group:["Group A","Group B","AM","PM","Day","Night"],
  name:["Lipkins","Assayag","Samad","Espejo","Garvida","Sortigosa","Lamas","Tacandong","Manansala","Harmon","Thomas","Laurino","Padillo","Valdez","Martinez","Mendiola","Wong","Jugo","Aguilar"],
  site:["Rosecrans A","Harbor B","Kei Ai A","Beachside B","Pacific Palms A (T3)","Pacific Palms A","TCCW","TCCW B","Gerontology","Sim A 1-7","Sim A","Sim B","Sim C","Maternity","Maternity Skills","End of Term 2","End of Term 3","Leadership","GI","GU","GU Skills","Cardio","Cardio Skills","Las Flores","Neurosensory","Admin","Make Up / Remediation","RN-BSN"],
  times:["07:00-15:30","08:00-16:30","15:00-23:30","21:00-07:00","07:00-12:00, 13:00-16:00","7:00 am-3:30 pm","3:00 pm-11:30 pm","8 hours","5.5hrs","3h, 5h"]
};
const tbody=document.getElementById('tbody'),search=document.getElementById('search');
const saveStatus=document.getElementById('saveStatus');

/* ===== Hours calc ===== */
function toMinutes(t){if(!t) return null;const s=norm(String(t).toLowerCase());const ampmMatch=/(am|pm|a|p)\b/.exec(s);const ampm=ampmMatch?ampmMatch[1]:null;const base=s.replace(/\b(am|pm|a|p)\b/g,'').trim();let[hh,mm='0']=base.includes(':')?base.split(':'):[base.slice(0,2),base.slice(2)];let h=parseInt(hh,10);let m=parseInt(mm,10)||0;if(Number.isNaN(h)||m<0||m>=60) return null;if(ampm){const isPM=ampm.startsWith('p');if(isPM&&h<12) h+=12;if(!isPM&&h===12) h=0;}return h*60+m;}
function hoursFromInput(input){if(!input) return 0;const parts=String(input).split(/[;,]+/).map(s=>s.trim()).filter(Boolean);const durRe=/^([0-9]+(?:\.[0-9]+)?)\s*(h|hr|hrs|hour|hours)?$/i;if(parts.every(p=>durRe.test(p))){let sum=0;for(const p of parts) sum+=parseFloat(p);return Math.round(sum*4)/4;}let total=0;for(const seg of parts){const[a,b]=seg.split('-').map(x=>x&&x.trim());const ms=toMinutes(a),me=toMinutes(b);if(ms!=null&&me!=null){let d=me-ms;if(d<0) d+=1440;total+=d;}}return Math.round((total/60)*4)/4;}
function applyBreak(h){return document.getElementById('breakToggle').checked?Math.max(0,Math.round((h-0.5)*4)/4):h;}

/* ===== Dropdowns ===== */
const cohortSel=document.getElementById('cohort'),cohortCustom=document.getElementById('cohortCustom');
const groupSel=document.getElementById('group'),groupCustom=document.getElementById('groupCustom');
const nameSel=document.getElementById('name'),nameCustom=document.getElementById('nameCustom');
const siteSel=document.getElementById('site'),siteCustom=document.getElementById('siteCustom');
const timesSel=document.getElementById('times'),timesCustom=document.getElementById('timesCustom');
function buildOptions(sel,arr){sel.innerHTML='<option value="">â€” Select â€”</option>'+arr.map(v=>`<option>${escapeHtml(v)}</option>`).join('')+'<option value="__custom__">Customâ€¦</option>';}
function rebuildSelects(){buildOptions(cohortSel,lists.cohort);buildOptions(groupSel,lists.group);buildOptions(nameSel,lists.name);buildOptions(siteSel,lists.site);buildOptions(timesSel,lists.times);buildOptions(document.getElementById('editCohort'),lists.cohort);buildOptions(document.getElementById('editGroup'),lists.group);buildOptions(document.getElementById('editName'),lists.name);buildOptions(document.getElementById('editSite'),lists.site);buildOptions(document.getElementById('editTimes'),lists.times);}
function toggleCustom(sel,input){if(sel.value==='__custom__'){input.classList.remove('hidden');input.focus();}else{input.classList.add('hidden');input.value='';}}
[[cohortSel,cohortCustom],[groupSel,groupCustom],[nameSel,nameCustom],[siteSel,siteCustom],[timesSel,timesCustom]].forEach(([s,c])=>s.addEventListener('change',()=>toggleCustom(s,c)));
function valFrom(sel,input){return sel.value==='__custom__'?input.value.trim():(sel.value||'').trim();}
function upsert(listName,val){val=String(val||'').trim();if(!val) return;const arr=lists[listName];if(!arr.some(x=>x.toLowerCase()===val.toLowerCase())) arr.push(val);}

/* ===== Persistence ===== */
function markSaved(){saveStatus.textContent='Saved '+new Date().toLocaleTimeString();setTimeout(()=>saveStatus.textContent='',3000);}
function persistRows(){localStorage.setItem(LS_ROWS,JSON.stringify(rows));markSaved();}
function persistLists(){localStorage.setItem(LS_LISTS,JSON.stringify(lists));markSaved();}

/* ===== Render table ===== */
function filtered(){const q=(search.value||'').toLowerCase().trim();if(!q) return rows;return rows.filter(r=>(r.date||'').includes(q)||[r.cohort,r.group,r.name,r.site,r.times].some(x=>String(x||'').toLowerCase().includes(q)));}
function render(){tbody.innerHTML='';for(const [i,r] of filtered().entries()){const tr=document.createElement('tr');tr.innerHTML=`<td>${escapeHtml(r.date||'')}</td><td>${escapeHtml(r.cohort||'')}</td><td>${escapeHtml(r.group||'')}</td><td>${escapeHtml(r.name||'')}</td><td>${escapeHtml(r.site||'')}</td><td>${escapeHtml(r.times||'')}</td><td><span class="pill">${applyBreak(r.hoursRaw)}</span></td><td class="row-actions"><button data-edit="${i}">Edit</button><button data-del="${i}" class="danger">Delete</button></td>`;tbody.appendChild(tr);}tbody.querySelectorAll('[data-edit]').forEach(b=>b.onclick=()=>openEdit(+b.dataset.edit));tbody.querySelectorAll('[data-del]').forEach(b=>b.onclick=()=>{rows.splice(+b.dataset.del,1);persistRows();render();});}

/* ===== Add / Edit ===== */
document.getElementById('addBtn').onclick=()=>{
  const date=document.getElementById('date').value.trim();
  const cohort=valFrom(cohortSel,cohortCustom);
  const group=valFrom(groupSel,groupCustom);
  const name=valFrom(nameSel,nameCustom);
  const site=valFrom(siteSel,siteCustom);
  const times=valFrom(timesSel,timesCustom);
  if(!date||!cohort||!name||!site||!times){alert('Please fill Date, Cohort, Faculty, Site, and Schedule.');return;}
  if(cohortSel.value==='__custom__') upsert('cohort',cohort);
  if(groupSel.value==='__custom__') upsert('group',group);
  if(nameSel.value==='__custom__') upsert('name',name);
  if(siteSel.value==='__custom__') upsert('site',site);
  if(timesSel.value==='__custom__') upsert('times',times);
  rows.push({date,cohort,group,name,site,times,hoursRaw:hoursFromInput(times)});persistRows();rebuildSelects();render();
  [cohortSel,groupSel,nameSel,siteSel,timesSel].forEach(s=>s.value='');[cohortCustom,groupCustom,nameCustom,siteCustom,timesCustom].forEach(i=>{i.value='';i.classList.add('hidden');});document.getElementById('date').value='';
};
let editing=-1;
function setSelect(sel,val){const opt=[...sel.options].find(o=>o.value===val||o.textContent===val);sel.value=opt?(opt.value||opt.textContent):'';}
function openEdit(i){editing=i;const r=rows[i];document.getElementById('editDate').value=r.date||'';setSelect(document.getElementById('editCohort'),r.cohort);setSelect(document.getElementById('editGroup'),r.group);setSelect(document.getElementById('editName'),r.name);setSelect(document.getElementById('editSite'),r.site);setSelect(document.getElementById('editTimes'),r.times);document.getElementById('editBackdrop').style.display='flex';}
document.getElementById('closeEdit').onclick=()=>document.getElementById('editBackdrop').style.display='none';
document.getElementById('saveEdit').onclick=()=>{if(editing<0)return;const date=document.getElementById('editDate').value.trim();const cohort=document.getElementById('editCohort').value.trim();const group=document.getElementById('editGroup').value.trim();const name=document.getElementById('editName').value.trim();const site=document.getElementById('editSite').value.trim();const times=document.getElementById('editTimes').value.trim();if(!date||!cohort||!name||!site||!times){alert('Fill required fields.');return;}rows[editing]={date,cohort,group,name,site,times,hoursRaw:hoursFromInput(times)};persistRows();rebuildSelects();render();document.getElementById('editBackdrop').style.display='none';};

/* ===== CSV/XLSX/Preview/Copy ===== */
function csvEscape(v){return '"'+String(v??'').replaceAll('"','""')+'"'}
function makeCsv(){const head=['Date','Cohort','Group','Faculty','Site','Schedule','Total Hours'];const data=rows.map(r=>[r.date,r.cohort,r.group,r.name,r.site,r.times,applyBreak(r.hoursRaw)].map(csvEscape).join(','));return head.join(',')+'\r\n'+data.join('\r\n');}
document.getElementById('exportCsvBtn').onclick=()=>{const blob=new Blob(['\ufeff'+makeCsv()],{type:'text/csv;charset=utf-8;'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download='nursing_faculty_schedule.csv';a.click();URL.revokeObjectURL(url);}
document.getElementById('copyCsvBtn').onclick=async()=>{try{await navigator.clipboard.writeText(makeCsv());alert('CSV copied to clipboard');}catch(e){alert('Clipboard permission blocked');}}
document.getElementById('previewCsvBtn').onclick=()=>{const head=['Date','Cohort','Group','Faculty','Site','Schedule','Total Hours'];const rowsHtml=rows.map(r=>`<tr><td>${escapeHtml(r.date||'')}</td><td>${escapeHtml(r.cohort||'')}</td><td>${escapeHtml(r.group||'')}</td><td>${escapeHtml(r.name||'')}</td><td>${escapeHtml(r.site||'')}</td><td>${escapeHtml(r.times||'')}</td><td>${applyBreak(r.hoursRaw)}</td></tr>`).join('');const html=`<!doctype html><html><head><meta charset="utf-8"><title>CSV Preview</title><style>body{font-family:ui-sans-serif,system-ui,Arial;margin:0}header{display:flex;justify-content:space-between;align-items:center;padding:12px;border-bottom:1px solid #e5e7eb}table{width:100%;border-collapse:collapse}th,td{border:1px solid #e5e7eb;padding:8px;text-align:left}thead th{background:#f9fafb;position:sticky;top:52px}@media print{@page{size:landscape;margin:10mm}}</style></head><body><header><strong>CSV Preview</strong><div><button onclick="window.print()">Print</button></div></header><div style="padding:12px"><table><thead><tr>${head.map(h=>`<th>${h}</th>`).join('')}</tr></thead><tbody>${rowsHtml}</tbody></table></div></body></html>`;const w=window.open('about:blank','_blank');w.document.write(html);w.document.close();}
document.getElementById('exportXlsxBtn').onclick=()=>{const aoa=[['Date','Cohort','Group','Faculty','Site','Schedule','Total Hours']];rows.forEach(r=>aoa.push([r.date,r.cohort,r.group,r.name,r.site,r.times,applyBreak(r.hoursRaw)]));const ws=XLSX.utils.aoa_to_sheet(aoa);const wb=XLSX.utils.book_new();XLSX.utils.book_append_sheet(wb,ws,'Schedule');const ab=XLSX.write(wb,{bookType:'xlsx',type:'array'});const blob=new Blob([ab],{type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download='nursing_faculty_schedule.xlsx';a.click();URL.revokeObjectURL(url);}

/* ===== Backup/Reset ===== */
document.getElementById('saveLocalBtn').onclick=()=>{persistRows();persistLists();alert('Saved locally.');}
document.getElementById('restoreLocalBtn').onclick=()=>{try{const r=JSON.parse(localStorage.getItem(LS_ROWS)||'null');if(Array.isArray(r)) rows=r;const l=JSON.parse(localStorage.getItem(LS_LISTS)||'null');if(l) lists=l;}catch(e){}rebuildSelects();render();alert('Restored.');}
document.getElementById('resetBtn').onclick=()=>{if(confirm('Clear ALL rows?')){rows=[];persistRows();render();}}

/* ===== Month Grid Preview (requested titles + spacer lines) ===== */
document.getElementById('monthGridBtn').onclick=()=>{
  if(!rows.length){alert('No rows imported yet.');return;}
  const first=rows.map(r=>r.date).filter(Boolean).sort()[0];
  const d0=new Date(first+'T00:00:00');const y=d0.getFullYear(),m=d0.getMonth()+1;
  const MONTH=new Date(y,m-1,1).toLocaleString(undefined,{month:'short'}).toUpperCase();
  const days=new Date(y,m,0).getDate();
  let cohorts=[...new Set(rows.map(r=>r.cohort||'').filter(Boolean))];
  // Sort by canonical order; display with requested labels when applicable
  cohorts.sort((a,b)=>{const ia=canonIndex(a),ib=canonIndex(b);return ia===ib?a.localeCompare(b):ia-ib;});
  const byDate={};
  for(const r of rows){(byDate[r.date]=byDate[r.date]||{});(byDate[r.date][r.cohort]=byDate[r.date][r.cohort]||[]).push(`${escapeHtml(r.site)} â€” ${escapeHtml(r.name)} â€” ${escapeHtml(r.times)}`);}
  const head=['MONTH','Day',...cohorts.map(c=>escapeHtml(displayLabel(c)))];
  const wk=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
  const body=[];
  for(let d=1;d<=days;d++){
    const dow=new Date(y,m-1,d).getDay();
    const iso=`${y}-${pad(m)}-${pad(d)}`;
    const cells=cohorts.map(c=>{
      const v=(byDate[iso]||{})[c]||[];
      // single blank spacer line between entries
      return `<td>${v.length?v.join('<br>&nbsp;<br>'):'<span style="color:#9ca3af">â€”</span>'}</td>`;
    }).join('');
    body.push(`<tr><td style="text-align:center;font-weight:700">${MONTH}</td><td><strong>${d}</strong> ${wk[dow]}</td>${cells}</tr>`);
  }
  const html=`<!doctype html><html><head><meta charset="utf-8"><title>${MONTH} ${y} â€” Month Grid</title><style>body{font-family:ui-sans-serif,system-ui,Arial;margin:0}header{display:flex;justify-content:space-between;align-items:center;padding:14px 16px;border-bottom:1px solid #e5e7eb}table{width:100%;border-collapse:collapse}th,td{border:1px solid #e5e7eb;padding:8px;vertical-align:top}thead th{background:#f9fafb;position:sticky;top:54px}@media print{@page{size:landscape;margin:10mm}}</style></head><body><header><h3>INSTRUCTORSâ€™ SCHEDULE â€” ${MONTH} ${y}</h3><button onclick="window.print()">Print</button></header><div style="padding:12px"><table><thead><tr>${head.map(h=>`<th>${h}</th>`).join('')}</tr></thead><tbody>${body.join('')}</tbody></table></div></body></html>`;
  const w=window.open('about:blank','_blank');w.document.write(html);w.document.close();
};

/* ===== Import XLSX/CSV/DOCX (inline prioritized, trio fallback, multiple day numbers per cell) ===== */
function detectMonthYear(aoa){const MONTH={JAN:1,FEB:2,MAR:3,APR:4,MAY:5,JUN:6,JUL:7,AUG:8,SEP:9,OCT:10,NOV:11,DEC:12};for(let r=0;r<Math.min(10,aoa.length);r++){const line=norm((aoa[r]||[]).join(' ')).toUpperCase();const m=line.match(/\b(JAN|FEB|MAR|APR|MAY|JUN|JUL|AUG|SEP|OCT|NOV|DEC)\b/);const y=line.match(/\b(20\d{2})\b/);if(m) return {month:MONTH[m[1]],year:y?+y[1]:new Date().getFullYear(),certain:true};}return {month:(new Date().getMonth()+1),year:new Date().getFullYear(),certain:false};}
function findDayColumn(aoa){const cols=Math.max(...aoa.map(r=>r.length));let bestCol=-1,bestHits=0;for(let c=0;c<cols;c++){let hits=0;for(let r=0;r<aoa.length;r++){const v=norm((aoa[r]||[])[c]||'');if(/^(0?[1-9]|[12]\d|3[01])$/.test(v)) hits++;}if(hits>bestHits){bestHits=hits;bestCol=c;}}return bestCol;}
function findHeaderRow(aoa,dayCol){let bestRow=-1,bestCount=-1;for(let r=0;r<Math.min(12,aoa.length);r++){const row=aoa[r]||[];let count=0;for(let c=dayCol+1;c<row.length;c++){if(norm(row[c])) count++;}if(count>bestCount){bestCount=count;bestRow=r;}}return bestRow;}
function parseMonthGrid(aoa,month,year){
  const dayCol=findDayColumn(aoa);if(dayCol<0) return[];
  const headerRow=findHeaderRow(aoa,dayCol);
  const headers=(aoa[headerRow]||[]).map(v=>norm(v));
  const cohorts=[];
  for(let c=dayCol+1;c<headers.length;c++){const lab=norm(headers[c]);if(lab) cohorts.push({c,label:lab});}
  cohorts.sort((a,b)=>{const ia=canonIndex(a.label),ib=canonIndex(b.label);return ia===ib?a.c-b.c:ia-ib;});

  function parseInlineTriple(line){
    const cleaned=norm(line).replace(/[â€“â€”]/g,'â€”');
    const parts=cleaned.split(/\s*â€”\s*|\s+-\s+/).map(norm).filter(Boolean);
    if(parts.length>=3){const site=parts[0];const name=parts[1];const times=parts.slice(2).join(' â€” ');if(site&&name&&times) return {site,name,times};}
    return null;
  }

  const out=[];
  let r=headerRow+1;
  while(r<aoa.length){
    const dayCell=norm((aoa[r]||[])[dayCol]||'');
    // support multiple day numbers in one cell (e.g., "1 1")
    const dayNums=dayCell.split(/[^0-9]+/).map(s=>s.trim()).filter(s=>/^(0?[1-9]|[12]\d|3[01])$/.test(s)).map(s=>+s);
    if(!dayNums.length){r++;continue;}

    const siteRow=aoa[r]||[],nameRow=aoa[r+1]||[],timeRow=aoa[r+2]||[];

    for(const dNum of dayNums){
      const iso=`${year}-${pad(month)}-${pad(dNum)}`;
      for(const h of cohorts){
        const siteRaw=norm(siteRow[h.c]||'');
        const nameRaw=norm(nameRow[h.c]||'');
        const timeRaw=norm(timeRow[h.c]||'');
        let added=false;
        // Priority: inline triples from any of the three cells (supports multi-line)
        const inlineCandidates=[siteRaw,nameRaw,timeRaw].filter(Boolean);
        for(const cell of inlineCandidates){
          for(const line of splitCell(cell)){
            const tri=parseInlineTriple(line);
            if(tri){out.push({date:iso,cohort:h.label,group:'',name:tri.name,site:tri.site,times:tri.times,hoursRaw:hoursFromInput(tri.times)});added=true;}
          }
        }
        if(added) continue;
        // Fallback: trio rows if >=2 rows have content; supports multiple lines per cell
        const S=splitCell(siteRaw),N=splitCell(nameRaw),T=splitCell(timeRaw);
        const nonEmpty=(S.length>0)+(N.length>0)+(T.length>0);
        if(nonEmpty>=2){
          const count=Math.max(S.length,N.length,T.length)||1;
          for(let k=0;k<count;k++){
            const site=S[k]??S[S.length-1]??'';
            const name=N[k]??N[N.length-1]??'';
            const times=T[k]??T[T.length-1]??'';
            if(site||name||times){out.push({date:iso,cohort:h.label,group:'',name,site,times,hoursRaw:hoursFromInput(times)});}
          }
        }
      }
    }
    r+=3; // next day block
  }
  return out;
}
function mergeMonth(imported){if(!imported.length) return 0;const prefix=imported[0].date.slice(0,7);rows=rows.filter(r=>!(r.date||'').startsWith(prefix)).concat(imported);persistRows();rebuildSelects();render();return imported.length;}
function forceMonthYearDialog(defaultMonth,defaultYear){return new Promise(res=>{document.getElementById('forceMonth').value=String(defaultMonth);document.getElementById('forceYear').value=String(defaultYear);document.getElementById('forceBackdrop').style.display='flex';document.getElementById('forceOk').onclick=()=>{const m=+document.getElementById('forceMonth').value;const y=+document.getElementById('forceYear').value;document.getElementById('forceBackdrop').style.display='none';res({month:m,year:y});};document.getElementById('forceCancel').onclick=()=>{document.getElementById('forceBackdrop').style.display='none';res(null);};});}

/* ===== File inputs & events ===== */
const importDocxBtn=document.getElementById('importDocxBtn'),importDocxInput=document.getElementById('importDocxInput');
importDocxBtn.onclick=()=>importDocxInput.click();
importDocxInput.addEventListener('change',async e=>{const f=e.target.files?.[0];if(!f) return;try{const ab=await f.arrayBuffer();const res=await window.mammoth.convertToHtml({arrayBuffer:ab});const doc=new DOMParser().parseFromString(res.value||'','text/html');const table=doc.querySelector('table');if(!table){alert('No table found.');return;}const aoa=[...table.querySelectorAll('tr')].map(tr=>[...tr.children].map(td=>td.textContent||''));const det=detectMonthYear(aoa);const chosen=det.certain?det:(await forceMonthYearDialog(det.month,det.year));if(!chosen) return;const imported=parseMonthGrid(aoa,chosen.month,chosen.year);alert(`Imported ${mergeMonth(imported)} rows for ${chosen.year}-${pad(chosen.month)}.`);}catch(err){console.error(err);alert('DOCX import failed: '+(err.message||'Unknown'));}finally{e.target.value='';}});

const importXlsxBtn=document.getElementById('importXlsxBtn'),importXlsxInput=document.getElementById('importXlsxInput');
importXlsxBtn.onclick=()=>importXlsxInput.click();
importXlsxInput.addEventListener('change',async e=>{
  const f=e.target.files?.[0];if(!f) return;
  try{
    if(/\.csv$/i.test(f.name)){
      const text=await f.text();
      const lines=text.split(/\r?\n/).filter(l=>l.trim()!=='');
      const aoa=lines.map(l=>{const m=l.match(/("([^"]|"")*"|[^,]+)/g)||[];return m.map(c=>c.replace(/^"|"$/g,'').replace(/""/g,'"'));});
      const det=detectMonthYear(aoa);const chosen=det.certain?det:(await forceMonthYearDialog(det.month,det.year));if(!chosen) return;
      const imported=parseMonthGrid(aoa,chosen.month,chosen.year);
      alert(`Imported ${mergeMonth(imported)} rows for ${chosen.year}-${pad(chosen.month)}.`);
    }else{
      const ab=await f.arrayBuffer();
      const wb=XLSX.read(ab,{type:'array'});const ws=wb.Sheets[wb.SheetNames[0]];
      const aoa=XLSX.utils.sheet_to_json(ws,{header:1,defval:'',blankrows:false,raw:true}).map(r=>r.map(v=>String(v)));
      const det=detectMonthYear(aoa);const chosen=det.certain?det:(await forceMonthYearDialog(det.month,det.year));if(!chosen) return;
      const imported=parseMonthGrid(aoa,chosen.month,chosen.year);
      alert(`Imported ${mergeMonth(imported)} rows for ${chosen.year}-${pad(chosen.month)}.`);
    }
  }catch(err){console.error(err);alert('Import failed: '+(err.message||'Unknown'));}
  finally{e.target.value='';}
});

/* ===== Manage Lists ===== */
const listsBackdrop=document.getElementById('listsBackdrop');
document.getElementById('manageListsBtn').onclick=()=>{listsBackdrop.style.display='flex';renderList('cohort');renderList('group');renderList('name');renderList('site');renderList('times');};
document.getElementById('closeLists').onclick=()=>listsBackdrop.style.display='none';
function renderList(key){const box=document.getElementById(key+'List');box.innerHTML=lists[key].map((v,i)=>`<div style="display:flex;justify-content:space-between;gap:8px;align-items:center;padding:6px 8px;border-bottom:1px solid var(--line)"><div>${escapeHtml(v)}</div><button data-k="${key}" data-i="${i}">Delete</button></div>`).join('');box.querySelectorAll('button').forEach(b=>b.onclick=()=>{const k=b.dataset.k,i=+b.dataset.i;if(confirm('Delete item?')){lists[k].splice(i,1);persistLists();rebuildSelects();renderList(k);}});}
document.getElementById('addCohort').onclick=()=>{const v=document.getElementById('newCohort').value.trim();if(v){upsert('cohort',v);persistLists();rebuildSelects();renderList('cohort');document.getElementById('newCohort').value='';}}
document.getElementById('addGroup').onclick=()=>{const v=document.getElementById('newGroup').value.trim();if(v){upsert('group',v);persistLists();rebuildSelects();renderList('group');document.getElementById('newGroup').value='';}}
document.getElementById('addName').onclick=()=>{const v=document.getElementById('newName').value.trim();if(v){upsert('name',v);persistLists();rebuildSelects();renderList('name');document.getElementById('newName').value='';}}
document.getElementById('addSite').onclick=()=>{const v=document.getElementById('newSite').value.trim();if(v){upsert('site',v);persistLists();rebuildSelects();renderList('site');document.getElementById('newSite').value='';}}
document.getElementById('addTimes').onclick=()=>{const v=document.getElementById('newTimes').value.trim();if(v){upsert('times',v);persistLists();rebuildSelects();renderList('times');document.getElementById('newTimes').value='';}}

/* ===== Init & autosave ===== */
(function init(){
  try{const r=JSON.parse(localStorage.getItem(LS_ROWS)||'null');if(Array.isArray(r)) rows=r;const l=JSON.parse(localStorage.getItem(LS_LISTS)||'null');if(l) lists=l;}catch{}
  // Ensure your requested display variants are present in Cohort list (non-destructive)
  ["NATP/ HHA","RN-BSN MSN","Make Up Tutoring"].forEach(v=>{ if(!lists.cohort.some(x=>canonKey(x)===canonKey(v))) lists.cohort.push(v); });
  rebuildSelects();render();
  search.addEventListener('input',render);
  document.getElementById('breakToggle').addEventListener('change',render);
  setInterval(()=>{persistRows();persistLists();},30000);
})();
</script>
</body>
</html>